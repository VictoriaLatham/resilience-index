# Load packages
library(tidyverse)
library(demographr)

source("functions/utils.R") # for download_file() & calculate_extent()

# Based on code/method from COVID-VI:
# https://github.com/britishredcrosssociety/covid-19-vulnerability/blob/master/prep%20CACI%20vulnerability%20data.r
# https://github.com/britishredcrosssociety/covid-19-vulnerability/blob/master/analysis%20-%20digital/calculate%20extent%20for%20digital%20vulnerability.r

# CACI digital vulnerability data ----
# Can't be shared publicly
vuln <- read_csv("data/on-disk/CACI/CCI_British Red Cross - UK Postcodes with Vunerability Indicators.csv")

# Digital vulnerability is combination of:
# fixed internet speed + online purchasing + online finance + mobile phone + internet user + confused by computer

# Lower decile values correspond to more vulnerable population
digital_vuln <- vuln |>
  select(
    postcode = Postcode,
    digital_vuln_decile = "Digital_combined_-_Decile"
  ) |>
  mutate(postcode = str_remove_all(postcode, " "))

# Postcode to MSOA lookup ----
# Source: https://www.arcgis.com/home/item.html?id=6a46e14a6c2441e3ab08c7b277335558
tf <- download_file("https://www.arcgis.com/sharing/rest/content/items/6a46e14a6c2441e3ab08c7b277335558/data", "zip")

tf |>
  unzip(exdir = tempdir())

postcode_lookup_raw <- read_csv(paste0(tempdir(), "/PCD_OA_LSOA_MSOA_LAD_FEB20_UK_LU.csv"))

postcode_lookup <- postcode_lookup_raw |>
  select(
    postcode = pcd7,
    lsoa_code = lsoa11cd,
    msoa_code = msoa11cd
  ) |>
  mutate(postcode = str_remove_all(postcode, " "))

# Check not found in lookup (and vice versa)
digital_vuln |>
  anti_join(postcode_lookup, by = "postcode")

postcode_lookup |>
  filter(str_detect(lsoa_code, "^E")) |>
  anti_join(digital_vuln, by = "postcode")

digital_msoa <- digital_vuln |>
  inner_join(postcode_lookup, by = "postcode") |>
  group_by(msoa_code) |>
  summarise(
    mean_decile = mean(digital_vuln_decile),
    median_decile = median(digital_vuln_decile)
  )

msoa_pop <- population_msoa_20 |>
  select(msoa_code, total_population)

# Calculate extent
digital_lad <- digital_msoa |>
  left_join(lookup_msoa_lad_21, by = c("msoa_code" = "msoa_11_code")) |>
  left_join(msoa_pop, by = "msoa_code") |>
  calculate_extent(
    var = mean_decile,
    higher_level_geography = lad_21_code,
    population = total_population,
    weight_high_scores = FALSE # lower value means higher vulnerability
  ) |>
  rename(digital_extent = extent, lad_code = lad_21_code)

digital_lad |>
  ggplot(aes(x = digital_extent)) +
  geom_boxplot()

# Save data -----
digital_lad |>
  write_rds("indices/disasters-emergencies/england/ltla/vulnerability-individual/data/digital-vulnerability.rds")