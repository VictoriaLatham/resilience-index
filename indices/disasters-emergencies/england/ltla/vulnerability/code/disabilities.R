# Load packages ----
library(tidyverse)
library(nomisr)

# Load data and prep ----
# Source: https://www.nomisweb.co.uk/query/construct/summary.asp?changing=yes&dataset=17&anal=5&version=0
# Variable: Percentage of working age adults (16 to 64 years old) who are disabled (under the Equality Act) or work-limiting disabled
# Parameter values in nomis_get_data() based on this URL: "https://www.nomisweb.co.uk/api/v01/dataset/NM_17_5.data.csv?geography=1816133633...1816133837&date=latest&variable=1733&measures=20599,21001,21002,21003"

nomisr_raw = nomis_get_data(
  id = "NM_17_5",
  date = "latest",
  geography = "TYPE432", #LADs
  variable = "1733", 
  measures = c("20599", "21001", "21002") # percentage, numerator & denominator
)

# Date of data (takes latest available data)
unique(nomisr_raw$DATE)

disabilities <- nomisr_raw |>
  select(lad_code = "GEOGRAPHY_CODE", measure = "MEASURES_NAME", value ="OBS_VALUE") |>
  filter(measure == "Variable",
         str_detect(lad_code, "^E")) |>
  mutate(disabilities_prop = value / 100) |>
  select(-c(measure, value)) 

disabilities |>
  filter(is.na(disabilities_prop))
# City of London & Isle of Scilly are missing

# Save ---- 
disabilities |>
  write_rds("data/vulnerability/disasters-emergencies/england/disabilities.rds")


