# Load packages ----
library(tidyverse)
library(demographr)

source("functions/utils.R")

# Load data and prep ----
elderly <- population_lsoa_20 |>
  rowwise() |>
  mutate(over_65 = sum(c_across(`66`:`90+`))) |>
  mutate(prop_over_65 = over_65 / total_population) |>
  select(lsoa_code, prop_over_65, total_population) |>
  left_join(lookup_lsoa_lad_21, by = c("lsoa_code")) |>
  ungroup()

elderly_lad <-
  elderly |>
  calculate_extent(
    var = prop_over_65,
    higher_level_geography = lad_code,
    population = total_population,
    weight_high_scores = TRUE # higher value means higher vulnerability
  ) |>
  rename(elderly_extent = extent)

elderly_lad |>
  ggplot(aes(x = elderly_extent)) +
  geom_boxplot()

# Save ----
elderly_lad |>
  write_rds("indices/disasters-emergencies/england/ltla/vulnerability/data/old-age.rds")