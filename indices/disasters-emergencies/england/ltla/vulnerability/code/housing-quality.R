library(tidyverse)
library(readxl)
library(demographr)

source("functions/utils.R")

# Technical notes of IMD indicators
# Page 56 https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833951/IoD2019_Technical_Report.pdf
# Was modeled using data from 2015 English Housing Survey

# Data source: https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
# File 8 on this landing page
tf <- download_file(
  "https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833992/File_8_-_IoD2019_Underlying_Indicators.xlsx",
  "xlxs"
)

raw <- read_excel(tf, sheet = "IoD2019 Living Env Domain")

housing <- raw |>
  select(lsoa_code = "LSOA code (2011)", poor_housing_ind = "Housing in poor condition indicator")

pop_lsoa <- population_lsoa_20 |>
  select(lsoa_code, total_population)

housing_lad <- housing |>
  left_join(pop_lsoa, by = "lsoa_code") |>
  left_join(lookup_lsoa_lad_21, by = c("lsoa_code")) |>
  calculate_extent(
    var = poor_housing_ind,
    higher_level_geography = lad_code,
    population = total_population,
    weight_high_scores = TRUE # higher value means higher vulnerability
  ) |>
  rename(housing_extent = extent)

housing_lad |>
  group_by(housing_extent) |>
  summarise(prop = n() / nrow(housing_lad)) |>
  filter(housing_extent %in% c(0, 1))
# 0: 1.9%
# 1: 0.3%

# Save data
housing_lad |>
  write_rds("indices/disasters-emergencies/england/ltla/vulnerability/data/housing-quality.rds")

# Note also mention of housing quality in ONS England Health Index See 'Quality of housing' section of ONS health index:
# https://www.ons.gov.uk/peoplepopulationandcommunity/healthandsocialcare/healthandwellbeing/methodologies/methodsusedtodevelopthehealthindexforengland2015to2018
# 'The potential source for measures of housing quality in terms of the state of repair of the property we identified is data produced by
# the Ministry of Housing, Communities and Local Government (MHCLG) using the English Housing Survey. These were found to be unsuitable as they
# cannot be disaggregated to the geographies required for the Health Index.'