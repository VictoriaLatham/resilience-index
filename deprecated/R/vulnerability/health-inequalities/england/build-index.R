# ---- Load libraries ----
library(tidyverse)
library(readxl)
library(geographr)
library(httr)
library(sf)

source("R/utils.R")

# ---- Load data ----
tf <-
  download_file(
    "https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fhealthandsocialcare%2fhealthandwellbeing%2fdatasets%2fhealthindexscoresengland%2fcurrent/healthindexscoresatnationalregionalandlocalauthoritylevelsenglandtimeseries.xlsx",
    ".xlsx"
  )

hi_domains <-
  read_excel(
    tf,
    sheet = "Table_7_2019_Index",
    skip = 4
  )

hi_overall <-
  read_excel(
    tf,
    sheet = "Table_2_Index_scores",
    skip = 2
  )

lad_21_codes <-
  boundaries_lad_21 |>
  st_drop_geometry() |>
  filter(str_detect(lad_21_code, "^E")) |>
  pull(lad_21_code)

# ---- Clean ----
# Keep vars of interest
hi_domains_select <-
  hi_domains |>
  select(
    lad_21_code = `Area Code`,
    healthy_people = `Healthy People Domain`,
    healthy_lives = `Healthy Lives Domain`,
    healthy_places = `Healthy Places Domain`
  )

hi_overall_select <-
  hi_overall |>
  select(
    lad_21_code = `Area Code`,
    overall_score = `2019`
  )

# Join overall and domain scores
hi_all <-
  hi_overall_select |>
  left_join(
    hi_domains_select,
    by = "lad_21_code"
  )

# Filter to only LTLA codes
hi_ltla <-
  hi_all |>
  filter(
    lad_21_code %in% lad_21_codes
  )

# Check that non-matched codes are not LTLA codes
unmatched_codes <-
  hi_all |>
  filter(
    !(lad_21_code %in% lad_21_codes)
  ) |>
  filter(str_detect(lad_21_code, "^E0")) |>
  pull(lad_21_code) |>
  length()

if (unmatched_codes != 0) {
  stop("Not all LTLA codes have been matched")
} else {
  print("Good job, you legend.")
}

# Check which codes are missing from 2021 lad code vector
# E06000053: Isles of Scilly
# E09000001: City of London
# From notes: "Except where combined with other areas as above, data are not
# provided for the Isles of Scilly or City of London due to small numbers.
setdiff(
  lad_21_codes, hi_ltla$lad_21_code
)

# Convert scores to ranks and deciles
hi_index_ranks <-
  hi_ltla %>%
  normalise_indicators() %>%
  mutate(
    across(
      where(is.numeric),
      inverse_rank
    )
  ) %>%
  rename_with(
    ~ str_c(.x, "rank", sep = "_"),
    where(is.numeric)
  )

hi_index_quantiles <-
  hi_ltla %>%
  normalise_indicators() %>%
  mutate(across(where(is.numeric), inverse_rank)) %>%
  mutate(across(where(is.numeric), quantise)) %>%
  rename_with(
    ~ str_c(.x, "quantile", sep = "_"),
    where(is.numeric)
  )

hi_index <-
  hi_index_ranks %>%
  left_join(hi_index_quantiles)

# Check distirbutions of quantiles
hi_index %>%
  pivot_longer(
    cols = ends_with("_quantile"),
    names_to = "domain",
    values_to = "quantile"
  ) %>%
  ggplot(aes(x = quantile, fill = domain)) +
  geom_histogram(alpha = .5) +
  facet_wrap(vars(domain)) +
  theme_minimal()

write_csv(
  hi_index,
  "data/vulnerability/health-inequalities/england/health-index-2019.csv"
)