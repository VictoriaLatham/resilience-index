# ---- Load ----
library(dplyr)
library(httr)
library(readODS)
library(geographr)
library(classInt)
source("R/utils.R")

# Source: https://gov.wales/welsh-index-multiple-deprivation-full-index-update-ranks-2019
GET(
  url = "https://gov.wales/sites/default/files/statistics-and-research/2019-11/welsh-index-multiple-deprivation-2019-index-and-domain-ranks-by-small-area.ods",
  write_disk(tf <- tempfile(fileext = ".ods"))
)

# For all ranks: 1 is most deprived
imd_raw <- read_ods(tf, sheet = "WIMD_2019_ranks", skip = 2)

imd_clean <-
  imd_raw %>%
  select(
    lsoa_code = `LSOA Code`,
    overall_rank = `WIMD 2019`
  ) %>% 
  as_tibble()

imd_lsoa <-
  imd_clean %>%
  mutate(
    deciles =
      quantise(
        overall_rank,
        num_quantiles = 10,
        highest_quantile_worst = FALSE
      )
  )

# ---- Calculate MSOA Deciles ----
# Aggregate LSOA -> MSOA
imd_msoa_extent <-
  imd_clean %>%
  left_join(lookup_lsoa_msoa, by = "lsoa_code") %>%
  left_join(population_msoa, by = "msoa_code") %>% 

  calculate_extent_depreciated(
    var = overall_rank,
    higher_level_geography = msoa_code,
    population = total_population,
    invert_percentiles = FALSE
  )

# Quantise into deciles
# quantise() fun will not work because calcuate_extent() does not permit the
# creation of equal breaks (as only worst 30% receive scores)
imd_msoa_rank <-
  imd_msoa_extent %>%
  mutate(
    rank = rank(extent)
  )

imd_breaks <- classIntervals(
  imd_msoa_rank$rank,
  10,
  style = "fisher"
)

imd_msoa <-
  imd_msoa_rank %>%
  mutate(
    deciles = as.integer(
      cut(
        rank,
        breaks = imd_breaks$brks,
        include.lowest = TRUE
      )
    )
  )

# ---- Calculate LAD Deciles ----
imd_lad_extent <-
  imd_clean %>%
  left_join(lookup_lsoa_msoa, by = "lsoa_code") %>%
  left_join(lookup_msoa_lad, by = "msoa_code") %>% 
  left_join(population_lad, by = "lad_code") %>% 
  
  calculate_extent_depreciated(
    var = overall_rank,
    higher_level_geography = lad_code,
    population = total_population,
    invert_percentiles = FALSE
  )

imd_lad <-
  imd_lad_extent %>%
  mutate(rank = rank(extent)) %>%
  mutate(
    deciles = quantise(
      rank,
      num_quantiles = 10
    )
  )

write_rds(
  imd_lsoa,
  "data/vulnerability/disasters-emergencies/wales/imd-lsoa.rds"
)
write_rds(
  imd_msoa,
  "data/vulnerability/disasters-emergencies/wales/imd-msoa.rds"
)
write_rds(
  imd_lad,
  "data/vulnerability/disasters-emergencies/wales/imd-lad.rds"
)
