library(tidyverse)
library(geographr)
library(demographr)
source("R/utils.R")

# Calculate elderly population proportions for MSOAs
elderly_msoa <-
  population_msoa_20_codes_11 |>
  filter(str_detect(msoa_11_code, "^W")) |>
  rowwise() |>
  mutate(over_65 = sum(c_across(`66`:`90+`))) |>
  ungroup() |>
  mutate(prop_over_65 = over_65 / total_population) |>
  select(msoa_code = msoa_11_code, prop_over_65, total_population)

# For LAD, calculate extent on proportions
elderly_lad <-
  elderly_msoa |>
  left_join(lookup_msoa11_ltla21, by = c("msoa_code" = "msoa11_code")) |>
  calculate_extent(
    var = prop_over_65,
    higher_level_geography = ltla21_code,
    population = total_population,
    weight_high_scores = TRUE
  ) |>
  rename(
    lad_code = ltla21_code,
    elderly_population = extent
  )

# Save
elderly_lad |>
  write_rds("data/vulnerability/disasters-emergencies/wales/elderly-population.rds")