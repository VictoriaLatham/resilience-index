# ---- Load ----
library(tidyverse)
library(readxl)
library(httr)
library(geographr)
library(demographr)
source("R/utils.R")

# Load CACI data computed in VI
living_alone_raw <-
  read_csv("https://raw.githubusercontent.com/britishredcrosssociety/covid-19-vulnerability/master/data/CACI/living-alone-lsoa.csv")

# Filter to Wales
living_alone_lsoa <-
  living_alone_raw |>
  filter(str_detect(LSOA11CD, "^W")) |>
  rename(
    lsoa_code = LSOA11CD,
    num_alone = `No. people living alone`
  )

# Calculate proportions
living_alone_prop <-
  living_alone_lsoa |>
  left_join(population_lsoa_20_codes_11, by = c("lsoa_code" = "lsoa_11_code")) |>
  mutate(prop_living_alone = num_alone / total_population) |>
  left_join(lookup_lsoa11_ltla21, by = c("lsoa_code" = "lsoa11_code")) |>
  select(lsoa_code, lad_code = ltla21_code, prop_living_alone, total_population)

living_alone_lad <-
  living_alone_prop |>
  calculate_extent(
    var = prop_living_alone,
    higher_level_geography = lad_code,
    population = total_population,
    weight_high_scores = TRUE
  ) |>
  rename(living_alone = extent)

living_alone_lad |>
  write_rds("data/vulnerability/disasters-emergencies/wales/living-alone.rds")