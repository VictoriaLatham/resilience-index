library(readr)
library(httr)
library(dplyr)
source("R/utils.R")

# The NOMIS API query creator was used to generate the url in the GET request:
# Source: https://www.nomisweb.co.uk/datasets/apsnew
# Data Set: Annual Population Survery
# Indicator: % aged 16-64 who are EA core or work-limiting disabled
disability_raw <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_17_5.data.csv?geography=1811939689,1811939680,1811939688,1811939683,1811939677,1811939675,1811939670...1811939672,1811939669,1811939668,1811939687,1811939691,1811939679,1811939692,1811939676,1811939674,1811939685,1811939678,1811939690,1811939682,1811939673&date=latest&variable=1733&measures=20599,21001,21002,21003")

# Keep vars of interest
disability <-
  disability_raw %>%
  select(
    lad_code = GEOGRAPHY_CODE,
    measures_name = MEASURES_NAME,
    disability_daily_activities_percent = OBS_VALUE
  ) %>%
  filter(measures_name == "Variable") %>%
  select(-measures_name)

# Convert to decimal
disability <-
  disability %>%
  mutate(disability_daily_activities_percent = disability_daily_activities_percent / 100) %>%
  rename(disability = disability_daily_activities_percent)

write_rds(disability, "data/vulnerability/disasters-emergencies/wales/disability.rds")