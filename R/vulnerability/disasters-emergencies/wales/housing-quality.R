#  Load package
library(readODS)
library(dplyr)
library(geographr)
library(classInt)
source("R/utils.R")

# Source: https://gov.wales/welsh-index-multiple-deprivation-full-index-update-ranks-2019
local_path <-
  download_file(
    url = "https://gov.wales/sites/default/files/statistics-and-research/2019-11/welsh-index-multiple-deprivation-2019-index-and-domain-ranks-by-small-area.ods",
    file_extension = ".ods"
  )

# For all ranks: 1 is most deprived
housing_raw <- read_ods(local_path, sheet = "WIMD_2019_ranks", skip = 2)

housing_clean <-
  housing_raw %>%
  select(
    lsoa_code = `LSOA Code`,
    housing_rank = `Housing`
  ) %>%
  as_tibble()

# ---- Calculate LAD Deciles ----
housing_lad_extent <-
  housing_clean %>%
  left_join(lookup_lsoa_msoa, by = "lsoa_code") %>%
  left_join(lookup_msoa_lad, by = "msoa_code") %>%
  left_join(population_lsoa, by = "lsoa_code") %>%
  calculate_extent(
    var = housing_rank,
    higher_level_geography = lad_code,
    population = total_population,
    weight_high_scores = FALSE # For all ranks: 1 is most deprived
  ) %>%
  rename(housing = extent)

write_rds(
  housing_lad_extent,
  "data/vulnerability/disasters-emergencies/wales/housing.rds"
)