# Load packages ----
library(tidyverse)
library(demographr)

# Once this table added to geographr then add to 
source("R/vulnerability/disasters-emergencies/lsoa_lad_2019_lookup.R")

source("https://raw.githubusercontent.com/britishredcrosssociety/resilience-index/main/R/utils.R") # for download_file() & calculate_extent()

# Load data and prep ----
# Load CACI data computed in VI
raw <-
  read_csv("https://raw.githubusercontent.com/britishredcrosssociety/covid-19-vulnerability/master/data/CACI/living-alone-lsoa.csv")

lsoa_pop <- population_lsoa_20 |>
  select(lsoa_code, total_population)

# Filter only England & join on MSOA and LA lookups
alone_england <- raw |>
  rename(lsoa_code = LSOA11CD, num_alone = `No. people living alone`) |>
  filter(str_detect(lsoa_code, "^E"))

alone_england_prop <- alone_england |>
  left_join(lookup_lsoa_11_lad_19, by = c("lsoa_code" = "lsoa_11_code")) |>
  left_join(lsoa_pop, by = c("lsoa_code")) |>
  mutate(prop_living_alone = num_alone / total_population)

# Check no missings in indicator data
lookup_lsoa_11_lad_19 |>
  filter(str_detect(lsoa_11_code, "^E")) |>
  anti_join(alone_england, by = c("lsoa_11_code" = "lsoa_code"))

living_alone_lad <-
  alone_england_prop |>
  calculate_extent(
    var = prop_living_alone,
    higher_level_geography = lad_19_code,
    population = total_population,
    weight_high_scores = TRUE # higher value means higher vulnerability
  ) |>
  rename(alone_extent = extent)

# Save ----
living_alone_lad |>
  rename(lad_code = lad_19_code) |>
  write_rds("data/vulnerability/disasters-emergencies/england/living-alone.rds")
