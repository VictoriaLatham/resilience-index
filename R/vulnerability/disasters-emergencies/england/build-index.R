# ---- Load libraries and Functions ----
library(tidyverse)
library(demographr)
library(geographr)

source("R/utils.R")

# ---- Load indicators ----
indicators <-
  load_indicators(
    path = "data/vulnerability/disasters-emergencies/england",
    key = "lad_code"
  )

# # Check entry for all 2019 LAD codes
# lads_19 <- lookup_lad_counties_19 |>
#   filter(str_detect(lad_19_code, "^E")) |>
#   distinct(lad_code = lad_19_code)
# 
# lads_19 |>
#   anti_join(indicators, by = "lad_code")
# 
# indicators |>
#   anti_join(lads_19, by = "lad_code")
# 
# indicators |>
#   dplyr::filter(if_any(everything(), ~is.na(.x)))
# # City of London & Isle of Scilly are missing disability data
# # Deal with this with 'ignore_nas' argument below

# Align direction so that high score = high vulnerability
indicators_aligned <- indicators |>
  mutate(digital_extent = digital_extent * -1)

# ---- Build Index ----
de <-
  indicators_aligned |>
  normalise_indicators(ignore_nas = TRUE) |>
  calculate_domain_scores(domain_name = "de", ignore_nas = TRUE) 

# Compare to 2021 LAD calcs 

