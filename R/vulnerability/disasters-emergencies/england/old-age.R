# Load packages ----
library(tidyverse)
library(demographr)

# Once this table added to geographr then add to 
source("R/vulnerability/disasters-emergencies/lsoa_lad_2019_lookup.R")

source("https://raw.githubusercontent.com/britishredcrosssociety/resilience-index/main/R/utils.R") # for download_file() & calculate_extent()

# Load data and prep ----
elderly <- population_lsoa_20 |>
  rowwise() |>
  mutate(over_65 = sum(c_across(`66`:`90+`))) |>
  mutate(prop_over_65 = over_65/ total_population) |>
  select(lsoa_code, prop_over_65, total_population) |>
  left_join(lookup_lsoa_11_lad_19, by = c("lsoa_code" = "lsoa_11_code")) |>
  ungroup() 

elderly_lad <-
  elderly |>
  calculate_extent(
    var = prop_over_65,
    higher_level_geography = lad_19_code,
    population = total_population,
    weight_high_scores = TRUE # higher value means higher vulnerability
  ) |>
  rename(elderly_extent = extent)

elderly_lad |>
  ggplot(aes(x = elderly_extent)) +
  geom_boxplot()

# Save ---- 
elderly_lad |>
  rename(lad_code = lad_19_code) |>
  write_rds("data/vulnerability/disasters-emergencies/england/old-age.rds")
