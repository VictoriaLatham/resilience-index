library(readr)
library(tidyr)
library(dplyr)
library(stringr)
library(nomisr)

# Census data from table QS103EW - Age by single year
#
# Nomis API URL: https://www.nomisweb.co.uk/api/v01/dataset/NM_503_1.jsonstat.json?date=latest&geography=1249902593...1249937345&rural_urban=0&c_age=0,5...12&measures=20100
census_raw <-
  nomis_get_data(
    id = "NM_503_1",
    date = "latest",
    geography = "TYPE298",  # LSOA
    
    rural_urban = "0",
    c_age = "0,5...12",
    
    measure = "20100"   # values
    
    # variables to keep
    # select = c(
    #   "GEOGRAPHY_CODE",
    #   "MEASURES_NAME",
    #   "CELL_NAME",
    #   "OBS_VALUE"
    # )
  )

# Calculate primary school aged population (aged 4 to 11 years) proportions for LSOAs
primary_school_children_lsoa <- 
  census_raw %>% 
  select(GEOGRAPHY_CODE, C_AGE_NAME, OBS_VALUE) %>% 
  pivot_wider(names_from = C_AGE_NAME, values_from = OBS_VALUE) %>% 
  mutate(proportion_primary_school_age = (`Age 4` + `Age 5` + `Age 6` + `Age 7` + `Age 8` + `Age 9` + `Age 10` + `Age 11`) / `All categories: Age`) %>% 
  select(lsoa_code = GEOGRAPHY_CODE, proportion_primary_school_age)

# Keep only England's LSOAs
primary_school_children_lsoa <- 
  primary_school_children_lsoa %>% 
  filter(str_detect(lsoa_code, "^E"))

# Save
primary_school_children_lsoa %>%
  write_rds("data/vulnerability/disasters-emergencies/flooding/2011-census/england/community-support/primary-school-children-lsoa-lsoa.rds")
