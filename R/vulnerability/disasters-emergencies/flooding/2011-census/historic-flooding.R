library(dplyr)
library(sf)
library(geographr)

source("R/utils.R")  # for download_file()

# Download historic flood map from https://environment.data.gov.uk/DefraDataDownload/?mapService=EA/HistoricFloodMap&Mode=spatial
# Note: You may need to generate a new download URL (below) from the link above
tf <- download_file("https://environment.data.gov.uk/UserDownloads/interactive/015ae0b56fe64bfd8ed0a6108107e56670824/EA_HistoricFloodMap_GeoJSON_Full.zip", ".zip")

unzip(tf, exdir = tempdir())

historic_flooding <- read_sf(file.path(tempdir(), "data", "Historic_Flood_Map.json"))

# historic_flooding <- st_transform(historic_flooding, crs = 4326)

# ---- Load Output Area boundaries ----
# Source: https://geoportal.statistics.gov.uk/datasets/ons::output-areas-december-2011-boundaries-ew-bfe/about
# Opening straight from the web takes far too long, so I manually downloaded a local copy and will load from that
# boundaries_oa <- read_sf("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Output_Areas_December_2011_Boundaries_EW_BFE/FeatureServer/0/query?where=1%3D1&outFields=OA11CD&outSR=4326&f=json")
boundaries_oa <- read_sf("data/vulnerability/disasters-emergencies/flooding/Output_Areas__December_2011__Boundaries_EW_BFE.shp")

# Look up which Output Areas are in historical flooding areas
flood_oa_shp <- 
  boundaries_oa %>% 
  st_join(historic_flooding)

flood_oa <- 
  flood_oa_shp %>% 
  st_drop_geometry() %>% 
  filter(!is.na(layer)) %>% 
  select(oa_code = OA11CD)

# ---- Look up number of people in each OA that has been historically flooded ----
flood_lsoa <- 
  flood_oa %>% 
  left_join(population_oa %>% select(oa_code, lsoa_code, total_population)) %>% 
  
  group_by(lsoa_code) %>% 
  summarise(people_flooded = sum(total_population)) %>% 
  ungroup() %>% 
  
  left_join(population_lsoa %>% select(lsoa_code, total_population)) %>% 
  mutate(proportion_people_flooded = people_flooded / total_population)

# ---- Get LSOA population in 2015 from IMD ----
# Fetch population denominators
tf_population <- 
  download_file("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833980/File_6_-_IoD2019_Population_Denominators.xlsx", ".xlsx")

raw_denominator <- 
  read_excel(
    tf_population,
    sheet = "Population Denominators"
  )

population <- 
  raw_denominator %>% 
  select(lsoa_code = `LSOA code (2011)`, population = `Total population: mid 2015 (excluding prisoners)`)


flood_lsoa_2015 <- 
  flood_oa %>% 
  left_join(population_oa %>% select(oa_code, lsoa_code, total_population)) %>% 
  
  group_by(lsoa_code) %>% 
  summarise(people_flooded = sum(total_population)) %>% 
  ungroup() %>% 
  
  left_join(population) %>% 
  mutate(proportion_people_flooded = people_flooded / population)

# Save
flood_lsoa_2015 %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2011-census/england/people-flooded.rds")
