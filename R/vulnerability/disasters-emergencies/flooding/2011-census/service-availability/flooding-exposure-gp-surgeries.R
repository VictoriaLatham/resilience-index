library(dplyr)
library(readr)
library(geographr)
library(stringr)

flood_risk_oa <- read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-output-areas.rds")

# Load GP surgery locations - using data from December 2011
# Source: https://data.gov.uk/dataset/176ae264-2484-4afe-a297-d51798eb8228/gp-practice-prescribing-data-presentation-level
gp_surgeries <- read_csv("https://files.digital.nhs.uk/4C/9E22A4/T201112ADDR%20BNFT.CSV", col_names = FALSE)

# Get Output Areas for each GP and see if they're at risk of flooding
gp_surgeries_flood_risk <- 
  gp_surgeries %>% 
  select(postcode = X8) %>% 
  mutate(postcode = gsub(" ", "", postcode)) %>% 
  left_join(lookup_postcode_oa_lsoa_msoa_lad) %>% 
  count(oa_code) %>% 
  left_join(flood_risk_oa)

# ---- Aggregate into Local Authorities ----
oa_lad <- 
  lookup_postcode_oa_lsoa_msoa_lad %>% 
  distinct(oa_code, lad_code)

# Calculate proportion of GP surgeries at risk of flooding in each LA
gp_surgeries_flood_risk_lad <- 
  gp_surgeries_flood_risk %>% 
  left_join(oa_lad) %>% 
  
  group_by(lad_code, flood_risk) %>% 
  summarise(n = sum(n)) %>% 
  ungroup() %>% 
  
  pivot_wider(names_from = flood_risk, values_from = n) %>% 
  mutate(proportion_gp_surgeries_flood_risk = `TRUE` / (`TRUE` + `FALSE`)) %>% 
  
  select(lad_code, proportion_gp_surgeries_flood_risk)

# ---- Assign the LA-level proportions to constituent LSOAs ----
gp_surgeries_flood_risk_lsoa <- 
  lookup_postcode_oa_lsoa_msoa_lad %>% 
  distinct(lsoa_code, lad_code) %>% 
  filter(str_detect(lsoa_code, "^E")) %>% 
  
  left_join(gp_surgeries_flood_risk_lad) %>% 
  select(-lad_code)

# Save
gp_surgeries_flood_risk_lsoa %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2011-census/england/community-support/flooding-exposure-gp-surgeries-lsoa.rds")

gp_surgeries_flood_risk_lad %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2011-census/england/community-support/flooding-exposure-gp-surgeries-lad.rds")
