library(readr)
library(tidyr)
library(dplyr)
library(stringr)
library(nomisr)

# Census data from table KS611EW to KS613EW - NS-SeC by sex
#
# Nomis API URL: https://www.nomisweb.co.uk/api/v01/dataset/NM_628_1.jsonstat.json?date=latest&geography=1249902593...1249937345&rural_urban=0&c_sex=0&cell=0,8...10&measures=20100
census_raw <-
  nomis_get_data(
    id = "NM_628_1",
    date = "latest",
    geography = "TYPE298",  # LSOA
    
    rural_urban = "0",
    c_sex = "0",
    cell = "0,8...10",
    
    measure = "20100",   # values
    
    # variables to keep
    select = c(
      "GEOGRAPHY_CODE",
      "MEASURES_NAME",
      "CELL_NAME",
      "OBS_VALUE"
    )
  )

low_income_occupations <- 
  census_raw %>% 
  pivot_wider(names_from = CELL_NAME, values_from = OBS_VALUE) %>% 
  mutate(proportion_low_income_occupations = (`6. Semi-routine occupations` + `7. Routine occupations`) / `All categories: NS-SeC`) %>% 
  select(lsoa_code = GEOGRAPHY_CODE, proportion_low_income_occupations)

# Save
low_income_occupations %>%
  write_rds("data/vulnerability/disasters-emergencies/flooding/2011-census/england/ability-to-prepare/low-income-occupations-lsoa.rds")

low_income_occupations %>%
  write_rds("data/vulnerability/disasters-emergencies/flooding/2011-census/england/ability-to-respond/low-income-occupations-lsoa.rds")

low_income_occupations %>%
  write_rds("data/vulnerability/disasters-emergencies/flooding/2011-census/england/ability-to-recover/low-income-occupations-lsoa.rds")
