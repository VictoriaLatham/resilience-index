library(dplyr)
library(readxl)

source("R/utils.R")  # for download_file()

# Fetch underlying indicators of deprivation
tf_indicators <- 
  download_file("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/467775/File_8_ID_2015_Underlying_indicators.xlsx", ".xlsx")

raw_numerator <-
  read_excel(
    tf_indicators,
    sheet = "ID 2015 Income Domain"
  )

income <- 
  raw_numerator %>% 
  select(lsoa_code = `LSOA code (2011)`, income_deprived = `Income Domain numerator`)

# Fetch population denominators
tf_population <- 
  download_file("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/467773/File_6_ID_2015_Population_denominators.xlsx", ".xlsx")

raw_denominator <- 
  read_excel(
    tf_population,
    sheet = "Population Denominators"
  )

population <- 
  raw_denominator %>% 
  select(lsoa_code = `LSOA code (2011)`, population = `Total population: mid 2012 (excluding prisoners)`)

# Population income deprived
income_deprived <- 
  income %>% 
  left_join(population) %>% 
  mutate(proportion_income_deprived = income_deprived / population) %>% 
  select(lsoa_code, proportion_income_deprived)

# Save
income_deprived %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2011-census/england/ability-to-prepare/income-deprived-lsoa.rds")

income_deprived %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2011-census/england/ability-to-respond/income-deprived-lsoa.rds")

income_deprived %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2011-census/england/ability-to-recover/income-deprived-lsoa.rds")
