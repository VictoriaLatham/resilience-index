# ---- Method ----
# Unlike other components in the Resilience Index, the flooding vulnerability 
# index is calculated (at the moment) following the method used by the original
# model: summing z-score of each indicator, all weighted equally.
#
# Technical docs:
#   - https://www.climatejust.org.uk/sites/default/files/appendix_b_neighbourhood_flood_vulnerability_index_-_final_-_uploaded_4june2017_revised_and_upload_280617_-_minor_corrections.pdf

# ---- Load libraries, functions and indicators ----
library(tidyverse)
source("R/utils.R")

# ---- Build Susceptibility domain ----
# Load indicators
susceptibility_indicators <-
  load_indicators(
    path = "data/vulnerability/disasters-emergencies/flooding/2022-interim/england/susceptibility",
    key = "lsoa_code",
    pattern = "-lsoa.rds"
  )

# Removed unwanted indicators
susceptibility_indicators <- 
  susceptibility_indicators %>% 
  select(-starts_with("num"), -starts_with("deciles"))

# Calculate z-scores
susceptibility_normalised <- 
  susceptibility_indicators %>% 
  normalise_indicators()

# Calculate domain scores
susceptibility_scores <- 
  susceptibility_normalised %>% 
  calculate_domain_scores(
    domain_name = "susceptibility",
    num_quantiles = 10
  )

# ---- Build Ability to Prepare domain ----
# Load indicators
prepare_indicators <-
  load_indicators(
    path = "data/vulnerability/disasters-emergencies/flooding/2022-interim/england/ability-to-prepare",
    key = "lsoa_code",
    pattern = "-lsoa.rds"
  )

# Calculate z-scores
prepare_normalised <- 
  prepare_indicators %>% 
  normalise_indicators()

# Calculate domain scores
prepare_scores <- 
  prepare_normalised %>% 
  calculate_domain_scores(
    domain_name = "ability_to_prepare",
    num_quantiles = 10
  )

# ---- Build Ability to Respond domain ----
# Load indicators
respond_indicators <-
  load_indicators(
    path = "data/vulnerability/disasters-emergencies/flooding/2022-interim/england/ability-to-respond",
    key = "lsoa_code",
    pattern = "-lsoa.rds"
  )

# Calculate z-scores
respond_normalised <- 
  respond_indicators %>% 
  normalise_indicators()

# Calculate domain scores
respond_scores <- 
  respond_normalised %>% 
  calculate_domain_scores(
    domain_name = "ability_to_respond",
    num_quantiles = 10
  )

# ---- Build Ability to Recover domain ----
# Load indicators
recover_indicators <-
  load_indicators(
    path = "data/vulnerability/disasters-emergencies/flooding/2022-interim/england/ability-to-recover",
    key = "lsoa_code",
    pattern = "-lsoa.rds"
  )

# Calculate z-scores
recover_normalised <- 
  recover_indicators %>% 
  normalise_indicators()

# Calculate domain scores
recover_scores <- 
  recover_normalised %>% 
  calculate_domain_scores(
    domain_name = "ability_to_recover",
    num_quantiles = 10
  )

# ---- Build Community Support domain ----
# Load indicators
support_indicators <-
  load_indicators(
    path = "data/vulnerability/disasters-emergencies/flooding/2022-interim/england/community-support",
    key = "lsoa_code",
    pattern = "-lsoa.rds"
  )

# Clean up columns
support_indicators <- 
  support_indicators %>% 
  select(-people_flooded, -total_population) %>% 
  mutate(proportion_people_flooded = replace_na(proportion_people_flooded, 0))

# Scale (align) indicators - Higher value = worse support.
support_scaled <-
  support_indicators %>% 
  mutate(
    proportion_people_flooded = proportion_people_flooded * -1
  )

# Calculate z-scores
support_normalised <- 
  support_scaled %>% 
  normalise_indicators()

# Calculate domain scores
support_scores <- 
  support_normalised %>% 
  calculate_domain_scores(
    domain_name = "community_support",
    num_quantiles = 10
  )

# ---- Combine Domains ----
# Combine domains with equal weighting to produce composite score
vulnerability_domain_scores <-
  susceptibility_scores |>
  left_join(
    prepare_scores,
    by = "lsoa_code"
  ) |>
  left_join(
    respond_scores,
    by = "lsoa_code"
  ) |>
  left_join(
    recover_scores,
    by = "lsoa_code"
  ) |>
  
  left_join(
    support_scores,
    by = "lsoa_code"
  ) |>
  
  select(
    lsoa_code,
    ends_with("domain_score")
  ) |>
  
  calculate_composite_score(
    index_name = "flood_vulnerability",
    num_quantiles = 10
  )

write_csv(
  vulnerability_domain_scores,
  "data/vulnerability/disasters-emergencies/flooding/2022-interim/england/flood-vulnerability-index.csv"
)
