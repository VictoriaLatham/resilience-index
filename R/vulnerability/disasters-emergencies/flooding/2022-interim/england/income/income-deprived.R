library(dplyr)
library(readxl)
# library(IMD)

source("R/utils.R")  # for download_file()

# Fetch underlying indicators of deprivation
tf_indicators <- 
  download_file("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833992/File_8_-_IoD2019_Underlying_Indicators.xlsx", ".xlsx")

raw_numerator <-
  read_excel(
    tf_indicators,
    sheet = "IoD2019 Income Domain"
  )

income <- 
  raw_numerator %>% 
  select(lsoa_code = `LSOA code (2011)`, income_deprived = `Income Domain numerator`)

# Fetch population denominators
tf_population <- 
  download_file("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833980/File_6_-_IoD2019_Population_Denominators.xlsx", ".xlsx")

raw_denominator <- 
  read_excel(
    tf_population,
    sheet = "Population Denominators"
  )

population <- 
  raw_denominator %>% 
  select(lsoa_code = `LSOA code (2011)`, population = `Total population: mid 2015 (excluding prisoners)`)

# Population income deprived
income_deprived <- 
  income %>% 
  left_join(population) %>% 
  mutate(proportion_income_deprived = income_deprived / population) %>% 
  select(lsoa_code, proportion_income_deprived)

# Save
income_deprived %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/ability-to-prepare/income-deprived-lsoa.rds")

income_deprived %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/ability-to-respond/income-deprived-lsoa.rds")

income_deprived %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/ability-to-recover/income-deprived-lsoa.rds")
