library(dplyr)
library(readxl)

source("R/utils.R")  # for download_file()

# Fetch underlying indicators of deprivation
tf_indicators <- 
  download_file("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833992/File_8_-_IoD2019_Underlying_Indicators.xlsx", ".xlsx")

raw_numerator <-
  read_excel(
    tf_indicators,
    sheet = "IoD2019 Employment Domain"
  )

unemployment <- 
  raw_numerator %>% 
  select(lsoa_code = `LSOA code (2011)`, unemployed = `Employment Domain numerator`)

# Fetch population denominators
tf_population <- 
  download_file("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833980/File_6_-_IoD2019_Population_Denominators.xlsx", ".xlsx")

raw_denominator <- 
  read_excel(
    tf_population,
    sheet = "Population Denominators"
  )

population <- 
  raw_denominator %>% 
  select(lsoa_code = `LSOA code (2011)`, population = `Working age population 18-59/64: for use with Employment Deprivation Domain (excluding prisoners)`)

# Population income deprived
unemployment <- 
  unemployment %>% 
  left_join(population) %>% 
  mutate(proportion_unemployed = unemployed / population) %>% 
  select(lsoa_code, proportion_unemployed)

# Save
unemployment %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/ability-to-prepare/proportion_unemployed-lsoa.rds")

unemployment %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/ability-to-respond/proportion_unemployed-lsoa.rds")

unemployment %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/ability-to-recover/proportion_unemployed-lsoa.rds")
