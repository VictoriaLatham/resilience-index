library(dplyr)
library(readr)
library(osmdata)
library(sf)
library(geographr)

source("R/utils.R")  # for download_file()

# Bounding box for England
england_bb <- getbb("England")

# Search for GP surgeries
gp_surgeries <- opq(england_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "doctors") %>%
  osmdata_sf()

# Lookup which LSOAs each GP surgery is in
gp_surgeries_lsoa <- 
  gp_surgeries$osm_points %>% 
  st_join(boundaries_lsoa)

gp_surgeries_lsoa %>% 
  st_drop_geometry() %>% 
  count(lsoa_code)

emergency_services <- opq(england_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "fire_station") %>%
  add_osm_feature("amenity", "police") %>%
  add_osm_feature("emergency", "ambulance_station") %>%
  osmdata_sf()

# Get Output Areas for each emergency service
emergency_services_oa <- 
  emergency_services$osm_points %>% 
  st_join(boundaries_oa)

# Schools data from https://www.compare-school-performance.service.gov.uk/download-data
schools <- read_csv("https://www.compare-school-performance.service.gov.uk/download-data?download=true&regions=0&filters=GIAS&fileformat=csv&year=2020-2021&meta=false")

# Get each school's Output Area - how many schools are in Output Areas at risk of flooding?
schools_oa <- 
  schools %>% 
  select(postcode = POSTCODE) %>% 
  mutate(postcode = gsub(" ", "", postcode)) %>% 
  left_join(lookup_postcode_oa_lsoa_msoa_lad) %>% 
  count(oa_code) %>% 
  left_join(flood_oa)


# Locations regulated by CQC: https://www.cqc.org.uk/about-us/transparency/using-cqc-data#directory
care_homes <- read_csv("https://www.cqc.org.uk/sites/default/files/09_February_2022_CQC_directory.csv", skip = 4)

care_homes_oa <- 
  care_homes %>% 
  filter(str_detec(`Service types`, "Residential")) %>% 
  select(postcode = POSTCODE) %>% 
  mutate(postcode = gsub(" ", "", postcode)) %>% 
  left_join(lookup_postcode_oa_lsoa_msoa_lad) %>% 
  count(oa_code) %>% 
  left_join(flood_oa)


# Aggregate into Local Authorities
oa_lad <- 
  lookup_postcode_oa_lsoa_msoa_lad %>% 
  distinct(oa_code, lad_code)

care_homes_oa %>% 
  left_join(oa_lad) %>% 
  
  group_by(lad_code) %>% 
  summarise(
    
  )


# ---- Load GP surgery locations ----
# Source: https://digital.nhs.uk/data-and-information/publications/statistical/patients-registered-at-a-gp-practice/february-2022
gp_surgeries <- read_csv("https://files.digital.nhs.uk/A0/52D736/gp-reg-pat-prac-all.csv")


# ---- Load flood risk areas ----
# Download historic flood map from https://environment.data.gov.uk/DefraDataDownload/?mapService=EA/HistoricFloodMap&Mode=spatial
# Note: You may need to generate a new download URL (below) from the link above
tf <- download_file("https://environment.data.gov.uk/UserDownloads/interactive/ce83de056162469ebe42c7f0dd36fd73145932/EA_FloodMapForPlanningRiversAndSeaFloodZone3_SHP_Full.zip", ".zip")

unzip(tf, exdir = tempdir())

flood_risk_areas <- read_sf(file.path(tempdir(), "data", "Flood_Map_for_Planning_Rivers_and_Sea_Flood_Zone_3.shp"))

# ---- Load Output Area boundaries ----
# Source: https://geoportal.statistics.gov.uk/datasets/ons::output-areas-december-2011-boundaries-ew-bfe/about
# Opening straight from the web takes far too long, so I manually downloaded a local copy and will load from that
# boundaries_oa <- read_sf("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Output_Areas_December_2011_Boundaries_EW_BFE/FeatureServer/0/query?where=1%3D1&outFields=OA11CD&outSR=4326&f=json")
boundaries_oa <- read_sf("data/vulnerability/disasters-emergencies/flooding/Output_Areas__December_2011__Boundaries_EW_BFE.shp")

# Look up which Output Areas are in flood risk areas
flood_oa_shp <- 
  boundaries_oa %>% 
  st_join(flood_risk_areas)

flood_oa <- 
  flood_oa_shp %>% 
  st_drop_geometry() %>% 
  filter(!is.na(layer)) %>% 
  select(oa_code = OA11CD) %>% 
  mutate(flood_risk = TRUE)

flood_oa <- 
  population_oa %>% 
  select(oa_code) %>% 
  left_join(flood_oa) %>% 
  mutate(flood_risk = replace_na(flood_risk, FALSE))

# This data will be used elsewhere, so save a copy rather than having to recalculate
flood_oa %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-output-areas.rds")
