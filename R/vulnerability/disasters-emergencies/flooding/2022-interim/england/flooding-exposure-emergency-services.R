library(dplyr)
library(readr)
library(osmdata)
library(sf)
library(geographr)

flood_risk_oa <- read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-output-areas.rds")

# ---- Load Output Area boundaries ----
# Source: https://geoportal.statistics.gov.uk/datasets/ons::output-areas-december-2011-boundaries-ew-bfe/about
# Opening straight from the web takes far too long, so I manually downloaded a local copy and will load from that
# boundaries_oa <- read_sf("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Output_Areas_December_2011_Boundaries_EW_BFE/FeatureServer/0/query?where=1%3D1&outFields=OA11CD&outSR=4326&f=json")
boundaries_oa <- read_sf("data/vulnerability/disasters-emergencies/flooding/Output_Areas__December_2011__Boundaries_EW_BFE.shp")

boundaries_oa <- st_transform(boundaries_oa, crs = 4326)

# ---- Get map points for each type of emergency service ----
# Bounding box for England
england_bb <- getbb("England")

fire <- 
  opq(england_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "fire_station") %>%
  osmdata_sf()

police <- 
  opq(england_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "police") %>%
  osmdata_sf()

ambo <- 
  opq(england_bb, timeout = 1000) %>%
  add_osm_feature("emergency", "ambulance_station") %>%
  osmdata_sf()

emergency_services <- 
  bind_rows(
    fire$osm_points,
    police$osm_points,
    ambo$osm_points
  ) %>% 
  select(osm_id, name)

emergency_services <- st_transform(emergency_services, crs = 27700)

# ---- Get Output Areas for each emergency service ----
st_crs(emergency_services) <- 4326  # Need to do this to make the next block of code work

emergency_services_oa <- 
  emergency_services %>% 
  st_join(boundaries_oa)

emergency_services_oa <- 
  emergency_services_oa %>% 
  st_drop_geometry() %>% 
  as_tibble() %>% 
  count(oa_code = OA11CD)

# emergency_services_oa %>% 
#   write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/flooding-exposure-emergency-services-oa.rds")
# 
# emergency_services_oa <-
#   read_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/flooding-exposure-emergency-services-oa.rds")

# Which OAs are in flood risk areas?
emergency_services_flood_risk_oa <- 
  emergency_services_oa %>% 
  left_join(flood_risk_oa)

# ---- Aggregate into Local Authorities ----
oa_lad <- 
  lookup_postcode_oa_lsoa_msoa_lad %>% 
  distinct(oa_code, lad_code)

# Calculate proportion of emergency services at risk of flooding in each LA
emergency_services_flood_risk_lad <- 
  emergency_services_flood_risk_oa %>% 
  left_join(oa_lad) %>% 
  
  group_by(lad_code, flood_risk) %>% 
  summarise(n = sum(n)) %>% 
  ungroup() %>% 
  
  pivot_wider(names_from = flood_risk, values_from = n) %>% 
  mutate(proportion_gp_surgeries_flood_risk = `TRUE` / (`TRUE` + `FALSE`)) %>% 
  
  select(lad_code, proportion_gp_surgeries_flood_risk)

# ---- Assign the LA-level proportions to constituent LSOAs ----
emergency_services_flood_risk_lsoa <- 
  lookup_postcode_oa_lsoa_msoa_lad %>% 
  distinct(lsoa_code, lad_code) %>% 
  filter(str_detect(lsoa_code, "^E")) %>% 
  
  left_join(emergency_services_flood_risk_lad) %>% 
  select(-lad_code)

# Save
emergency_services_flood_risk_lsoa %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/flooding-exposure-emergency-services-lsoa.rds")

emergency_services_flood_risk_lad %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/flooding-exposure-emergency-services-lad.rds")
