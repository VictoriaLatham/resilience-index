library(readr)
library(tidyr)
library(dplyr)
library(stringr)
library(geographr)
source("R/utils.R")

# Calculate younger population (aged 5 or younger) proportions for LSOAs
younger_lsoa <- 
  population_lsoa %>% 
  filter(str_detect(lsoa_code, "^E")) %>% 
  
  pivot_longer(cols = `0`:`90+`, names_to = "Age", values_to = "n_people") %>%
  mutate(Age = as.integer(str_extract(Age, "[0-9]+"))) %>%
  
  group_by(lsoa_code) %>%
  summarise(
    num_people = sum(n_people),
    num_people_under_5 = sum(n_people[Age <= 5], na.rm = TRUE)
  ) %>%
  
  mutate(proportion_under_5 = num_people_under_5 / num_people) %>%
  mutate(
    deciles = quantise(
      proportion_under_5,
      num_quantiles = 10,
      highest_quantile_worst = TRUE
    )
  )

# Save
younger_lsoa %>%
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/younger-population-lsoa.rds")
