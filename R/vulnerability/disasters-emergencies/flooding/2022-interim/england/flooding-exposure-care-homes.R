library(dplyr)
library(readr)
library(geographr)
library(stringr)

flood_risk_oa <- read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-output-areas.rds")

# Locations regulated by CQC: https://www.cqc.org.uk/about-us/transparency/using-cqc-data#directory
care_homes <- read_csv("https://www.cqc.org.uk/sites/default/files/09_February_2022_CQC_directory.csv", skip = 4)

care_homes_oa <- 
  care_homes %>% 
  filter(str_detec(`Service types`, "Residential")) %>% 
  select(postcode = POSTCODE) %>% 
  mutate(postcode = gsub(" ", "", postcode)) %>% 
  left_join(lookup_postcode_oa_lsoa_msoa_lad) %>% 
  count(oa_code) %>% 
  left_join(flood_oa)


# Aggregate into Local Authorities
oa_lad <- 
  lookup_postcode_oa_lsoa_msoa_lad %>% 
  distinct(oa_code, lad_code)

care_homes_oa %>% 
  left_join(oa_lad) %>% 
  
  group_by(lad_code) %>% 
  summarise(
    
  )

