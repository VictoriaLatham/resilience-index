library(dplyr)
library(sf)
library(geographr)
library(demographr)

source("R/utils.R")  # for download_file()

# Download historic flood map from https://environment.data.gov.uk/DefraDataDownload/?mapService=EA/HistoricFloodMap&Mode=spatial
# Note: You may need to generate a new download URL (below) from the link above
tf <- download_file("https://environment.data.gov.uk/UserDownloads/interactive/4d131c9e82924e00be760e9ea1b4f181210524/EA_HistoricFloodMap_GeoJSON_Full.zip", ".zip")

unzip(tf, exdir = tempdir())

historic_flooding <- read_sf(file.path(tempdir(), "data", "Historic_Flood_Map.json"))

# ---- Load Output Area boundaries ----
# Source: https://geoportal.statistics.gov.uk/datasets/ons::output-areas-december-2011-boundaries-ew-bfe/about
# Opening straight from the web takes far too long, so I manually downloaded a local copy and will load from that
# boundaries_oa <- read_sf("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Output_Areas_December_2011_Boundaries_EW_BFE/FeatureServer/0/query?where=1%3D1&outFields=OA11CD&outSR=4326&f=json")
boundaries_oa <- read_sf("data/vulnerability/disasters-emergencies/flooding/Output_Areas__December_2011__Boundaries_EW_BFE.shp")

# Look up which Output Areas are in historical flooding areas
flood_oa_shp <- 
  boundaries_oa %>% 
  st_transform(crs = st_crs(historic_flooding)) %>%
  st_join(historic_flooding)
  

flood_oa <- 
  flood_oa_shp %>% 
  st_drop_geometry() %>% 
  filter(!is.na(layer)) %>% 
  select(oa11_code = OA11CD) %>%
  # make distinct as a OA can intersect with multiple flood planes which causes duplicates
  distinct(oa11_code)

# ---- Look up number of people in each OA that has been historically flooded ----
flood_lsoa <- 
  flood_oa %>% 
  left_join(population20_oa11 %>% select(oa11_code, lsoa11_code, total_population), by = "oa11_code") %>% 
  group_by(lsoa11_code) %>% 
  summarise(people_flooded = sum(total_population)) %>% 
  ungroup() %>% 
  left_join(population20_lsoa11 %>% select(lsoa11_code, total_population), by = "lsoa11_code") %>% 
  mutate(proportion_people_flooded = people_flooded / total_population) |>
  rename(lsoa_code = lsoa11_code)

# Save
flood_lsoa %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/community-support/people-flooded-lsoa.rds")
