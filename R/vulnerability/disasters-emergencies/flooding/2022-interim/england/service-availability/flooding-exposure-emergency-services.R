library(dplyr)
library(readr)
library(osmdata)
library(sf)
library(geographr)
library(stringr)
library(ggplot2)

flood_risk_oa <- read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-output-areas.rds")

# ---- Load Output Area boundaries ----
# Source: https://geoportal.statistics.gov.uk/datasets/ons::output-areas-december-2011-boundaries-ew-bfe/about
# Opening straight from the web takes far too long, so I manually downloaded a local copy and will load from that
# boundaries_oa <- read_sf("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Output_Areas_December_2011_Boundaries_EW_BFE/FeatureServer/0/query?where=1%3D1&outFields=OA11CD&outSR=4326&f=json")
boundaries_oa <- read_sf("data/vulnerability/disasters-emergencies/flooding/Output_Areas__December_2011__Boundaries_EW_BFE.shp")

boundaries_oa_eng <- boundaries_oa %>%
  filter(str_detect(OA11CD, "^E"))

# ---- Get map points for each type of emergency service ----
# Bounding box for England
england_bb <- getbb("England")

fire <- 
  opq(england_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "fire_station") %>%
  osmdata_sf()

police <- 
  opq(england_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "police") %>%
  osmdata_sf()

ambo <- 
  opq(england_bb, timeout = 1000) %>%
  add_osm_feature("emergency", "ambulance_station") %>%
  osmdata_sf()

emergency_services_points <- 
  bind_rows(
    fire$osm_points,
    police$osm_points,
    ambo$osm_points,
    .id = "service"
  ) %>% 
  select(osm_id, name, service) %>%
  mutate(service = recode(service, 
                          `1` = "fire", 
                          `2` = "police", 
                          `3` = "ambo"))

emergency_services_polygons <- 
  bind_rows(
    fire$osm_polygons,
    police$osm_polygons,
    ambo$osm_polygons,
    .id = "service"
  ) %>% 
  select(osm_id, name, service) %>%
  mutate(service = recode(service, 
                          `1` = "fire", 
                          `2` = "police", 
                          `3` = "ambo"))

emergency_services_multipolygons <- 
  bind_rows(
    fire$osm_multipolygons,
    police$osm_multipolygons,
    ambo$osm_multipolygons,
    .id = "service"
  ) %>% 
  select(osm_id, name, service) %>%
  mutate(service = recode(service, 
                          `1` = "fire", 
                          `2` = "police", 
                          `3` = "ambo"))

emergency_services_points_proj <- st_transform(emergency_services_points, crs = st_crs(boundaries_oa))
emergency_services_polygons_proj <- st_transform(emergency_services_polygons, crs = st_crs(boundaries_oa))
emergency_services_multipolygons_proj <- st_transform(emergency_services_multipolygons, crs = st_crs(boundaries_oa))

# ---- Get Output Areas for each emergency service ----
emergency_services_points_oa <- 
  emergency_services_points_proj %>% 
  st_join(boundaries_oa_eng)

emergency_services_polygons_oa <- 
  emergency_services_polygons_proj %>% 
  st_join(boundaries_oa_eng)

emergency_services_multipolygons_oa <- 
  emergency_services_multipolygons_proj %>% 
  st_join(boundaries_oa_eng)

# Checking those with no OA match ----------------
# Are in Ireland, Scot, Wales & France (picked up do to boundary box in line 21)
emergency_services_points_oa |>
  mutate(no_oa_match = if_else(is.na(OA11CD), T, F)) |>
  ggplot() + 
  geom_sf(aes(colour = no_oa_match))

emergency_services_polygons_oa |>
  mutate(no_oa_match = if_else(is.na(OA11CD), T, F)) |>
  ggplot() + 
  geom_sf(aes(colour = no_oa_match))

# Checking reasonableness of total numbers of each service -----
# Source: https://www.gov.uk/government/statistical-data-sets/fire-statistics-data-tables
# Fire: 'FIRE1403: Fire stations and appliances, by fire and rescue authority tab'
# In 2020 1,393 Fire Stations in England 

# https://www.ukcrimestats.com/Police_Stations/
# 355 Police stations

# https://www.londonambulance.nhs.uk/talking-with-us/how-to-find-us/
# 70 Ambulance stations in London

# Return only those in England borders
emergency_services_points_eng <- 
  emergency_services_points_proj %>% 
  st_join(boundaries_oa_eng, left = FALSE)

emergency_services_polygons_eng <- 
  emergency_services_polygons_proj %>% 
  st_join(boundaries_oa_eng, left = FALSE)

emergency_services_multipolygons_eng <- 
  emergency_services_multipolygons_proj %>% 
  st_join(boundaries_oa_eng, left = FALSE)

emergency_services_points_eng %>%
  st_drop_geometry() %>% 
  group_by(service) %>%
  summarise(count = n())
# ambo:3286, fire:11065, police:11123

emergency_services_polygons_eng %>%
  st_drop_geometry() %>% 
  group_by(service) %>%
  summarise(count = n_distinct(osm_id))
# ambo:401, fire:1182, police:955

emergency_services_multipolygons_eng %>%
  st_drop_geometry() %>% 
  group_by(service) %>%
  summarise(count = n_distinct(osm_id))
# ambo: 2, fire:5, police:40

# Do any of the points and polygons overlap?
point_poly_overlap <- emergency_services_points_eng |>
  st_join(emergency_services_polygons_eng, left = FALSE)

length(unique(point_poly_overlap$osm_id.x)) / nrow(emergency_services_points_eng)
# 96% of points are within a polygon
# i.e. ~1k points are not accounted for in the polygons

# Do any of the polygons and multipolygons overlap?
poly_multipoly_overlap <- emergency_services_polygons_eng |>
  st_join(emergency_services_multipolygons_eng, left = FALSE)

length(unique(poly_multipoly_overlap$osm_id.x)) / nrow(emergency_services_polygons_eng)
# 3% of polygons overlap with a multipolygon

# Do any of the points and multpolygons overlap?
point_multipoly_overlap <- emergency_services_points_eng |>
  st_join(emergency_services_multipolygons_eng, left = FALSE)

length(unique(point_multipoly_overlap$osm_id.x)) / nrow(emergency_services_points_eng)
# 4% of points are within a multipolygon


# Points not in the polygons ----
point_not_poly <- emergency_services_points_eng |>
  st_join(emergency_services_polygons_eng) |>
  filter(is.na(osm_id.y)) 

# are any of these in the multipolygons?
point_multipoly_overlap_ids <- point_multipoly_overlap |>
  st_drop_geometry() |>
  distinct(osm_id.x) |>
  pull()

point_not_poly |>
  filter(osm_id.x %in% point_multipoly_overlap_ids) |>
  nrow()
# 100 of the 1000
  
  

# Map polygons and then points not within polygons
norfolk <- getbb("Norfolk") |>
  st_transform(crs = st_crs(emergency_services_polygons_oa_eng))

emergency_services_polygons_oa_eng |>
  ggplot() +
  geom_sf() +
  geom_sf(data = point_not_poly, aes(colour = "red")) +
coord_sf(xlim = norfolk[, 1],ylim = norfolk[, 2])

################################################################
# To consider reliability and duplication of nearby points
################################################################

# emergency_services_oa <- 
#   emergency_services_oa %>% 
#   st_drop_geometry() %>% 
#   as_tibble() %>% 
#   count(oa_code = OA11CD)
# 
# # emergency_services_oa %>% 
# #   write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/flooding-exposure-emergency-services-oa.rds")
# # 
# # emergency_services_oa <-
# #   read_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/flooding-exposure-emergency-services-oa.rds")
# 
# # Which OAs are in flood risk areas?
# emergency_services_flood_risk_oa <- 
#   emergency_services_oa %>% 
#   left_join(flood_risk_oa)
# 
# # ---- Aggregate into Local Authorities ----
# oa_lad <- 
#   lookup_postcode_oa_lsoa_msoa_lad %>% 
#   distinct(oa_code, lad_code)
# 
# # Calculate proportion of emergency services at risk of flooding in each LA
# emergency_services_flood_risk_lad <- 
#   emergency_services_flood_risk_oa %>% 
#   left_join(oa_lad) %>% 
#   
#   group_by(lad_code, flood_risk) %>% 
#   summarise(n = sum(n)) %>% 
#   ungroup() %>% 
#   
#   pivot_wider(names_from = flood_risk, values_from = n) %>% 
#   mutate(proportion_emergency_services_flood_risk = `TRUE` / (`TRUE` + `FALSE`)) %>% 
#   
#   select(lad_code, proportion_emergency_services_flood_risk)
# 
# # ---- Assign the LA-level proportions to constituent LSOAs ----
# emergency_services_flood_risk_lsoa <- 
#   lookup_postcode_oa_lsoa_msoa_lad %>% 
#   distinct(lsoa_code, lad_code) %>% 
#   filter(str_detect(lsoa_code, "^E")) %>% 
#   
#   left_join(emergency_services_flood_risk_lad) %>% 
#   select(-lad_code)
# 
# # Save
# emergency_services_flood_risk_lsoa %>% 
#   write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/community-support/flooding-exposure-emergency-services-lsoa.rds")
# 
# emergency_services_flood_risk_lad %>% 
#   write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/community-support/flooding-exposure-emergency-services-lad.rds")
