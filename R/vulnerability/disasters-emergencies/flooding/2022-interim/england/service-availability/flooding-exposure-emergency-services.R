library(dplyr)
library(readr)
library(osmdata)
library(sf)
library(geographr)
library(stringr)
library(ggplot2)
library(tidyr)

source("R/utils.R") # for osm_data_reduce()

flood_risk_oa <- read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-output-areas.rds")

# ---- Load Output Area boundaries ----
# Source: https://geoportal.statistics.gov.uk/datasets/ons::output-areas-december-2011-boundaries-ew-bfe/about
# Opening straight from the web takes far too long, so I manually downloaded a local copy and will load from that
# boundaries_oa <- read_sf("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Output_Areas_December_2011_Boundaries_EW_BFE/FeatureServer/0/query?where=1%3D1&outFields=OA11CD&outSR=4326&f=json")
boundaries_oa <- read_sf("data/vulnerability/disasters-emergencies/flooding/Output_Areas__December_2011__Boundaries_EW_BFE.shp")

boundaries_oa_eng <- boundaries_oa |>
  filter(str_detect(OA11CD, "^E"))

# ---- Get map points for each type of emergency service ----
# Bounding box for England
england_bb <- getbb("England")

fire <-
  opq(england_bb, timeout = 1000) |>
  add_osm_feature("amenity", "fire_station") |>
  osmdata_sf()

police <-
  opq(england_bb, timeout = 1000) |>
  add_osm_feature("amenity", "police") |>
  osmdata_sf()

ambo <-
  opq(england_bb, timeout = 1000) |>
  add_osm_feature("emergency", "ambulance_station") |>
  osmdata_sf()

# Use function to reduce duplication of points relating to the same building ----
sf::sf_use_s2(FALSE) # turn off s2 as otherwise get joining errors about spherical geometries
fire_reduce <- osm_data_reduce(fire)
ambo_reduce <- osm_data_reduce(ambo)
police_reduce <- osm_data_reduce(police)

# Issue in dplyr where can't use id argument when binding sf objects?
# https://github.com/tidyverse/dplyr/issues/5780
services <- bind_rows(
  fire_reduce,
  ambo_reduce,
  police_reduce
) |>
  mutate(service = case_when(
    osm_id %in% police_reduce$osm_id & osm_id %in% fire_reduce$osm_id & osm_id %in% ambo_reduce$osm_id ~ "ambo_fire_police",
    osm_id %in% fire_reduce$osm_id & osm_id %in% ambo_reduce$osm_id ~ "ambo_fire",
    osm_id %in% police_reduce$osm_id & osm_id %in% ambo_reduce$osm_id ~ "ambo_police",
    osm_id %in% police_reduce$osm_id & osm_id %in% fire_reduce$osm_id ~ "fire_police",
    osm_id %in% fire_reduce$osm_id ~ "fire",
    osm_id %in% ambo_reduce$osm_id ~ "ambo",
    osm_id %in% police_reduce$osm_id ~ "police",
    TRUE ~ NA_character_
  ))

# Check service counts
services |>
  st_drop_geometry() |>
  group_by(service) |>
  summarise(count = n())
# ambo: 575, ambo_fire: 12, fire: 1920, police: 2001

services |>
  st_drop_geometry() |>
  group_by(osm_id) |>
  mutate(count_id = n()) |>
  filter(count_id > 1)

# Check count of the geometry types
services |>
  mutate(area = st_area(geometry)) |>
  st_drop_geometry() |>
  mutate(point_poly = if_else(area == units::as_units(0, value = "m^2"), "point", "poly")) |>
  group_by(point_poly) |>
  summarise(count = n())

# Keep only those within England boundary ----
# Not this will cause duplicated polygon/multipolygon rows where it crosses multiple OAs
services_eng <- services |>
  st_transform(crs = st_crs(boundaries_oa_eng)) |>
  st_join(boundaries_oa_eng, left = FALSE)

services_eng |>
  st_drop_geometry() |>
  group_by(service) |>
  summarise(count = n_distinct(osm_id))
# ambo: 502, ambo_fire: 1, fire: 1520, police: 1462

# Checking those with no OA match ----------------
# Are in Ireland, Scot, Wales & France (picked up do to boundary box in line 21)
services |>
  st_transform(crs = st_crs(boundaries_oa_eng)) |>
  st_join(boundaries_oa_eng) |>
  mutate(no_oa_match = if_else(is.na(OA11CD), T, F)) |>
  ggplot() +
  geom_sf(aes(colour = no_oa_match))

# Checking reasonableness of total numbers of each service -----
# Source: https://www.gov.uk/government/statistical-data-sets/fire-statistics-data-tables
# Fire: 'FIRE1403: Fire stations and appliances, by fire and rescue authority tab'
# In 2020 1,393 Fire Stations in England

# https://www.ukcrimestats.com/Police_Stations/
# 355 Police stations

# https://www.londonambulance.nhs.uk/talking-with-us/how-to-find-us/
# 70 Ambulance stations in London

# Cases when multiple points/polygons/multipolygons of same service per OA 
# Assumption: unlikely will be building for same service with same OA so assume is duplicate
services_eng_dedup <- osm_oa_deduping(services_eng, OA11CD)

services_eng_dedup |>
  st_drop_geometry() |>
  group_by(service) |>
  summarise(count = n_distinct(osm_id))
# ambo: 463, ambo_fire: 1, fire: 1410, police: 1317


# Dealing with buildings which span across multiple OAs ------
buildings_multiple_oas <- services_eng_dedup |>
  group_by(osm_id, service) |>
  mutate(multiple_oas = n_distinct(OA11CD)) |>
  filter(multiple_oas > 1)

# 'largest = TRUE' argument below joins the OA with the largest overlap with the buildings
# https://github.com/r-spatial/sf/issues/578
# Was unable to use this on whole dataset on line 91 due to an error
buildings_multiple_oas_largest_oa <- services |>
  st_make_valid() |> # https://github.com/r-spatial/sf/issues/870
  filter(osm_id %in% buildings_multiple_oas$osm_id) |>
  st_transform(crs = st_crs(boundaries_oa_eng)) |>
  st_join(boundaries_oa_eng, left = FALSE, largest = TRUE)

# Combine the outputs
services_final_output <- services_eng_dedup |>
  filter(!osm_id %in% buildings_multiple_oas$osm_id) |>
  bind_rows(buildings_multiple_oas_largest_oa)

# Check no duplicates
services_final_output |>
  group_by(osm_id, service) |>
  mutate(count_osm_id = n()) |>
  filter(count_osm_id > 1)


# Which OAs are in flood risk areas? ----
emergency_services_flood_risk_oa <-
  services_final_output |>
  st_drop_geometry() |>
  left_join(flood_risk_oa, by = c("OA11CD" = "oa_code")) |>
  select(osm_id, service, oa_11_code = OA11CD, flood_risk)

# ---- Aggregate into Local Authorities ----
oa_lad <-
  lookup_postcode_oa_11_lsoa_11_msoa_11_lad_20 |>
  distinct(oa_11_code, lad_20_code)

# Calculate proportion of emergency services at risk of flooding in each LA
emergency_services_flood_risk_lad <-
  emergency_services_flood_risk_oa |>
  left_join(oa_lad, by = "oa_11_code") |>
  group_by(lad_20_code, flood_risk) |>
  summarise(n = n()) |>
  ungroup() |>
  pivot_wider(names_from = flood_risk, values_from = n) |>
  mutate(proportion_emergency_services_flood_risk = `TRUE` / (`TRUE` + `FALSE`)) |>
  select(lad_code = lad_20_code, proportion_emergency_services_flood_risk)

# ---- Assign the LA-level proportions to constituent LSOAs ----
emergency_services_flood_risk_lsoa <-
  lookup_postcode_oa_11_lsoa_11_msoa_11_lad_20 |>
  distinct(lsoa_11_code, lad_20_code) |>
  filter(str_detect(lsoa_11_code, "^E")) |>
  left_join(emergency_services_flood_risk_lad, by = c("lad_20_code" = "lad_code")) |>
  select(-lad_20_code) |>
  rename(lsoa_code = lsoa_11_code)

# Save
emergency_services_flood_risk_lsoa |>
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/community-support/flooding-exposure-emergency-services-lsoa.rds")

emergency_services_flood_risk_lad |>
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/community-support/flooding-exposure-emergency-services-lad.rds")
