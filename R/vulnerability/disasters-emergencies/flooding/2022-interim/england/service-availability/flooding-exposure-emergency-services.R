library(dplyr)
library(readr)
library(osmdata)
library(sf)
library(geographr)
library(stringr)
library(ggplot2)
library(tidyr)

flood_risk_oa <- read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-output-areas.rds")

# ---- Load Output Area boundaries ----
# Source: https://geoportal.statistics.gov.uk/datasets/ons::output-areas-december-2011-boundaries-ew-bfe/about
# Opening straight from the web takes far too long, so I manually downloaded a local copy and will load from that
# boundaries_oa <- read_sf("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Output_Areas_December_2011_Boundaries_EW_BFE/FeatureServer/0/query?where=1%3D1&outFields=OA11CD&outSR=4326&f=json")
boundaries_oa <- read_sf("data/vulnerability/disasters-emergencies/flooding/Output_Areas__December_2011__Boundaries_EW_BFE.shp")

boundaries_oa_eng <- boundaries_oa %>%
  filter(str_detect(OA11CD, "^E"))

# ---- Get map points for each type of emergency service ----
# Bounding box for England
england_bb <- getbb("England")

fire <-
  opq(england_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "fire_station") %>%
  osmdata_sf()

police <-
  opq(england_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "police") %>%
  osmdata_sf()

ambo <-
  opq(england_bb, timeout = 1000) %>%
  add_osm_feature("emergency", "ambulance_station") %>%
  osmdata_sf()

# Use function to reduce duplication of points relating to the same building ----
sf::sf_use_s2(FALSE) # turn off s2 as otherwise get joining errors about spherical geometries
fire_reduce <- osm_data_reduce(fire)
ambo_reduce <- osm_data_reduce(ambo)
police_reduce <- osm_data_reduce(police)

# Issue in dplyr where can't use id argument when binding sf objects?
# https://github.com/tidyverse/dplyr/issues/5780
services <- bind_rows(
  fire_reduce,
  ambo_reduce,
  police_reduce
) |>
  mutate(service = case_when(
    osm_id %in% police_reduce$osm_id & osm_id %in% fire_reduce$osm_id & osm_id %in% ambo_reduce$osm_id ~ "ambo_fire_police",
    osm_id %in% fire_reduce$osm_id & osm_id %in% ambo_reduce$osm_id ~ "ambo_fire",
    osm_id %in% police_reduce$osm_id & osm_id %in% ambo_reduce$osm_id ~ "ambo_police",
    osm_id %in% police_reduce$osm_id & osm_id %in% fire_reduce$osm_id ~ "fire_police",
    osm_id %in% fire_reduce$osm_id ~ "fire",
    osm_id %in% ambo_reduce$osm_id ~ "ambo",
    osm_id %in% police_reduce$osm_id ~ "police",
    TRUE ~ NA_character_
  ))

# Check service counts
services  |>
  st_drop_geometry() |>
  group_by(service) |>
  summarise(count = n())
# ambo: 575, ambo_fire: 12, fire: 1920, police: 2001

services |>
  st_drop_geometry() |>
  group_by(osm_id) |>
  mutate(count_id = n()) |>
  filter(count_id > 1)

# Check count of the geometry types 
services |>
  mutate(area = st_area(geometry)) |>
  st_drop_geometry() |>
  mutate(point_poly = if_else(area ==  units::as_units(0, value = "m^2"), "point", "poly")) |>
  group_by(point_poly) |>
  summarise(count = n())

# Keep only those within England boundary ----
# Not this will cause duplicated polygon/multipolygon rows where it crosses multiple OAs
services_eng <- services  |>
  st_transform(crs = st_crs(boundaries_oa_eng)) |>
  st_join(boundaries_oa_eng, left = FALSE)

services_eng |>
  st_drop_geometry() |>
  group_by(service) |>
  summarise(count = n_distinct(osm_id))
# ambo: 502, ambo_fire: 1, fire: 1520, police: 1462

# Checking those with no OA match ----------------
# Are in Ireland, Scot, Wales & France (picked up do to boundary box in line 21)
services  |>
  st_transform(crs = st_crs(boundaries_oa_eng)) |>
  st_join(boundaries_oa_eng) |>
  mutate(no_oa_match = if_else(is.na(OA11CD), T, F)) |>
  ggplot() +
  geom_sf(aes(colour = no_oa_match))

# Checking reasonableness of total numbers of each service -----
# Source: https://www.gov.uk/government/statistical-data-sets/fire-statistics-data-tables
# Fire: 'FIRE1403: Fire stations and appliances, by fire and rescue authority tab'
# In 2020 1,393 Fire Stations in England

# https://www.ukcrimestats.com/Police_Stations/
# 355 Police stations

# https://www.londonambulance.nhs.uk/talking-with-us/how-to-find-us/
# 70 Ambulance stations in London

# Check when multiple buildings of same type per OA as this is highly unlikely 
services_eng_dups <- services_eng %>%
  group_by(OA11CD, service) %>%
  mutate(count_id = n()) %>%
  filter(count_id > 1) |>
  arrange(desc(count_id), OA11CD, name) %>%
  st_transform(crs = 4326)

# Take top one where has name (if not null for all) and then the largest size
services_eng_dedup <- services_eng_dups %>%
  mutate(size = st_area(geometry)) %>%
  group_by(OA11CD, service) %>%
  arrange(OA11CD, name, desc(size)) |>
  slice(1)
  
services_eng_dedup <- services_eng |>
  filter(!osm_id %in% services_eng_dups$osm_id) |>
  bind_rows(services_eng_dedup)

services_eng_dedup |>
  st_drop_geometry() |>
  group_by(service) |>
  summarise(count = n_distinct(osm_id))
# ambo: 463, ambo_fire: 1, fire: 1410, police: 1317
  
################################
# TO DO FROM HERE ########
################################

# Join on flood risk OAs ------
flood_risk_services <- services_eng %>%
  st_drop_geometry() %>%
  left_join(flood_risk_oa, by = c("OA11CD" = "oa_code")) |>
  group_by(osm_id) %>%
  summarise(flood_risk_count = sum(flood_risk)) |>
  filter(flood_risk_count > 0) |>
  select(osm_id) |>
  pull()

# ---- Aggregate into Local Authorities ----
oa_lad <-
  lookup_postcode_oa_11_lsoa_11_msoa_11_lad_20 %>%
  distinct(oa_11_code, lad_20_code) |>
  filter(str_detect(lad_20_code, "^E"))

# Calculate proportion of emergency services at risk of flooding in each LA
# Few cases where polygon straddles 2 LAs - come back to as few cases
emergency_services_flood_risk_lad <-
  services_eng %>%
  st_drop_geometry() %>%
  left_join(oa_lad, by = c("OA11CD" = "oa_11_code")) %>%
  distinct(osm_id, lad_20_code) %>%
  mutate(flood_risk = ifelse(osm_id %in% flood_risk_services, T, F)) %>%
  group_by(lad_20_code, flood_risk) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  pivot_wider(names_from = flood_risk, values_from = n) %>%
  mutate(proportion_emergency_services_flood_risk = `TRUE` / (`TRUE` + `FALSE`)) %>%
  select(lad_20_code, proportion_emergency_services_flood_risk)

emergency_services_flood_risk_lad %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/community-support/flooding-exposure-emergency-services-lad.rds")

# Don't output the results at LSOA level 
