library(dplyr)
library(readr)
library(osmdata)
library(sf)
library(geographr)
library(stringr)
library(ggplot2)
library(tidyr)

flood_risk_oa <- read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-output-areas.rds")

# ---- Load Output Area boundaries ----
# Source: https://geoportal.statistics.gov.uk/datasets/ons::output-areas-december-2011-boundaries-ew-bfe/about
# Opening straight from the web takes far too long, so I manually downloaded a local copy and will load from that
# boundaries_oa <- read_sf("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Output_Areas_December_2011_Boundaries_EW_BFE/FeatureServer/0/query?where=1%3D1&outFields=OA11CD&outSR=4326&f=json")
boundaries_oa <- read_sf("data/vulnerability/disasters-emergencies/flooding/Output_Areas__December_2011__Boundaries_EW_BFE.shp")

boundaries_oa_eng <- boundaries_oa %>%
  filter(str_detect(OA11CD, "^E"))

# ---- Get map points for each type of emergency service ----
# Bounding box for England
england_bb <- getbb("England")

fire <-
  opq(england_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "fire_station") %>%
  osmdata_sf()

police <-
  opq(england_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "police") %>%
  osmdata_sf()

ambo <-
  opq(england_bb, timeout = 1000) %>%
  add_osm_feature("emergency", "ambulance_station") %>%
  osmdata_sf()

emergency_services_points <-
  bind_rows(
    fire$osm_points,
    police$osm_points,
    ambo$osm_points,
    .id = "service"
  ) %>%
  select(osm_id, name, service) %>%
  mutate(service = recode(service,
    `1` = "fire",
    `2` = "police",
    `3` = "ambo"
  ))

emergency_services_polygons <-
  bind_rows(
    fire$osm_polygons,
    police$osm_polygons,
    ambo$osm_polygons,
    .id = "service"
  ) %>%
  select(osm_id, name, service) %>%
  mutate(service = recode(service,
    `1` = "fire",
    `2` = "police",
    `3` = "ambo"
  ))

emergency_services_multipolygons <-
  bind_rows(
    fire$osm_multipolygons,
    police$osm_multipolygons,
    ambo$osm_multipolygons,
    .id = "service"
  ) %>%
  select(osm_id, name, service) %>%
  mutate(service = recode(service,
    `1` = "fire",
    `2` = "police",
    `3` = "ambo"
  ))

emergency_services_points_proj <- st_transform(emergency_services_points, crs = st_crs(boundaries_oa))
emergency_services_polygons_proj <- st_transform(emergency_services_polygons, crs = st_crs(boundaries_oa))
emergency_services_multipolygons_proj <- st_transform(emergency_services_multipolygons, crs = st_crs(boundaries_oa))

# ---- Get Output Areas for each emergency service ----
emergency_services_points_oa <-
  emergency_services_points_proj %>%
  st_join(boundaries_oa_eng)

emergency_services_polygons_oa <-
  emergency_services_polygons_proj %>%
  st_join(boundaries_oa_eng)

emergency_services_multipolygons_oa <-
  emergency_services_multipolygons_proj %>%
  st_join(boundaries_oa_eng)

# Checking those with no OA match ----------------
# Are in Ireland, Scot, Wales & France (picked up do to boundary box in line 21)
emergency_services_points_oa |>
  mutate(no_oa_match = if_else(is.na(OA11CD), T, F)) |>
  ggplot() +
  geom_sf(aes(colour = no_oa_match))

emergency_services_polygons_oa |>
  mutate(no_oa_match = if_else(is.na(OA11CD), T, F)) |>
  ggplot() +
  geom_sf(aes(colour = no_oa_match))

# Checking reasonableness of total numbers of each service -----
# Source: https://www.gov.uk/government/statistical-data-sets/fire-statistics-data-tables
# Fire: 'FIRE1403: Fire stations and appliances, by fire and rescue authority tab'
# In 2020 1,393 Fire Stations in England

# https://www.ukcrimestats.com/Police_Stations/
# 355 Police stations

# https://www.londonambulance.nhs.uk/talking-with-us/how-to-find-us/
# 70 Ambulance stations in London

# Return only those in England borders
emergency_services_points_eng <-
  emergency_services_points_proj %>%
  st_join(boundaries_oa_eng, left = FALSE)

emergency_services_polygons_eng <-
  emergency_services_polygons_proj %>%
  st_join(boundaries_oa_eng, left = FALSE)

emergency_services_multipolygons_eng <-
  emergency_services_multipolygons_proj %>%
  st_join(boundaries_oa_eng, left = FALSE)

emergency_services_points_eng %>%
  st_drop_geometry() %>%
  group_by(service) %>%
  summarise(count = n())
# ambo:3286, fire:11065, police:11123

emergency_services_polygons_eng %>%
  st_drop_geometry() %>%
  group_by(service) %>%
  summarise(count = n_distinct(osm_id))
# ambo:401, fire:1182, police:955

emergency_services_multipolygons_eng %>%
  st_drop_geometry() %>%
  group_by(service) %>%
  summarise(count = n_distinct(osm_id))
# ambo: 2, fire:5, police:40

# Checks between points, polygons and multiploygons ----

# Do any of the polygons and multipolygons overlap?
polygons_multipolygons_overlap <- emergency_services_multipolygons_eng |>
  st_join(emergency_services_polygons_eng, left = FALSE)

length(unique(polygons_multipolygons_overlap$osm_id.x)) / nrow(emergency_services_multipolygons_eng)
# 80% of multipolygons intersect with a polygon

# Do any of the points and polygons overlap?
point_poly_overlap <- emergency_services_points_eng |>
  st_join(emergency_services_polygons_eng, left = FALSE)

length(unique(point_poly_overlap$osm_id.x)) / nrow(emergency_services_points_eng)
# 96% of points are within a polygon
# i.e. ~1k points are not accounted for in the polygons

# Do any of the points and multpolygons overlap?
point_multipoly_overlap <- emergency_services_points_eng |>
  st_join(emergency_services_multipolygons_eng, left = FALSE)

length(unique(point_multipoly_overlap$osm_id.x)) / nrow(emergency_services_points_eng)
# 4% of points are within a multipolygon

# Map polygons and then points not within polygons ----
# Testing Isle of Wight (10 stations - https://en.wikipedia.org/wiki/Isle_of_Wight_Fire_and_Rescue_Service)
emergency_services_polygons_oa_eng |>
  st_transform(crs = 4326) |>
  filter(service == "fire", LAD11CD == "E06000046") |>
  ggplot() +
  geom_sf_label(aes(label = name), size = 2) +
  coord_sf(xlim = zoom[1, ], ylim = zoom[2, ])
# 3 as polygons

point_not_poly |>
  st_transform(crs = 4326) |>
  filter(service.x == "fire", LAD11CD.x == "E06000046") |>
  ggplot() +
  geom_sf() +
  geom_sf_label(aes(label = name.x), size = 2) +
  coord_sf(xlim = zoom[1, ], ylim = zoom[2, ])
# 7 as points

# Steps to reduce duplication of points ----

# Keep polygons not already covered in the multipolygons
polyons_not_multipolygon_overlap <- emergency_services_polygons_proj |>
  st_join(emergency_services_multipolygons_proj) |>
  filter(is.na(osm_id.y)) |>
  distinct(osm_id.x) |>
  pull()

polygons_to_keep <- emergency_services_polygons_proj |>
  filter(osm_id %in% polyons_not_multipolygon_overlap)

# Keep points not already covered in a multipolygon or a polygon
points_not_polygon_multipolygon_overlap <- emergency_services_points_proj |>
  st_join(emergency_services_multipolygons_proj) |>
  filter(is.na(osm_id.y)) |>
  st_join(emergency_services_polygons_proj) |>
  filter(is.na(osm_id)) |>
  distinct(osm_id.x) |>
  pull()

points_to_keep <- emergency_services_points_proj |>
  filter(osm_id %in% points_not_polygon_multipolygon_overlap)

combined <- emergency_services_multipolygons_proj |>
  bind_rows(polygons_to_keep) |>
  bind_rows(points_to_keep)

combined |> 
  st_drop_geometry() |> 
  group_by(osm_id) |> 
  mutate(count = n()) |> 
  filter(count > 1) |>
  arrange(osm_id)
# 6 cases where is both a fire and an ambulance station

# Only want those in boundaries of England & find which OA they are in
# Note that polygons and multipolygons may cross more than 1 OA so may get duplicated rows
combined_eng <- combined |>
  st_join(boundaries_oa_eng, left = FALSE)

combined_eng |>
  st_drop_geometry() %>%
  group_by(osm_id) |>
  summarise(count = n()) |>
  filter(count > 1)

combined_eng %>%
  st_drop_geometry() %>%
  group_by(service) %>%
  summarise(count = n_distinct(osm_id))
# ambo:482, fire:1495, police: 1406


flood_risk_services <-  combined_eng %>%
  st_drop_geometry() %>%
  left_join(flood_risk_oa, by = c("OA11CD" = "oa_code")) |>
  group_by(osm_id) %>%
  summarise(flood_risk_count = sum(flood_risk)) |>
  filter(flood_risk_count > 0) |>
  select(osm_id) |>
  pull()

# ---- Aggregate into Local Authorities ----
oa_lad <-
  lookup_postcode_oa_11_lsoa_11_msoa_11_lad_20 %>%
  distinct(oa_11_code, lad_20_code) |>
  filter(str_detect(lad_20_code, "^E"))

# Calculate proportion of emergency services at risk of flooding in each LA
# Few cases where polygon straddles 2 LAs - come back to as few cases
emergency_services_flood_risk_lad <-
  combined_eng %>%
  st_drop_geometry() %>%
  left_join(oa_lad, by = c("OA11CD" = "oa_11_code")) %>%
  distinct(osm_id, lad_20_code) %>%
  mutate(flood_risk = ifelse(osm_id %in% flood_risk_services, T, F)) %>%
  group_by(lad_20_code, flood_risk) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  pivot_wider(names_from = flood_risk, values_from = n) %>%
  mutate(proportion_emergency_services_flood_risk = `TRUE` / (`TRUE` + `FALSE`)) %>%
  select(lad_20_code, proportion_emergency_services_flood_risk)

previous_appraoch <- read_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/community-support/flooding-exposure-emergency-services-lad.rds")

emergency_services_flood_risk_lad |>
  left_join(previous_appraoch, by = c("lad_20_code" = "lad_code")) |>
  mutate(diff = proportion_emergency_services_flood_risk.x - proportion_emergency_services_flood_risk.y) |>
  summary()
