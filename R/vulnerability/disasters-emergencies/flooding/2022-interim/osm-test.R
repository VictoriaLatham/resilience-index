# ---- Load libs ----
library(tidyverse)
library(osmdata)
library(sf)
library(geographr)

# ---- Get map points for each type of emergency service ----
# Bounding box for Wales
wales_bb <- getbb("Wales")

fire <-
  opq(wales_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "fire_station") %>%
  osmdata_sf()

police <-
  opq(wales_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "police") %>%
  osmdata_sf()

ambo <-
  opq(wales_bb, timeout = 1000) %>%
  add_osm_feature("emergency", "ambulance_station") %>%
  osmdata_sf()

emergency_services <-
  bind_rows(
    fire$osm_points,
    police$osm_points,
    ambo$osm_points
  ) %>%
  select(osm_id, name)

# ---- Set Wales boundaries ----
boundaries_wales <-
  boundaries_ltla21 |> 
  filter(str_detect(ltla21_code, "^W"))

# ---- Check CRS align ----
emergency_services_crs <-
  emergency_services |> 
  st_crs()

boundaries_ltla21_crs <-
  boundaries_wales |> 
  st_crs()

if(emergency_services_crs != boundaries_ltla21_crs){
  stop("CRS not aligned")
}

# ---- Inspect plots ----
# Just osm points:
#   - Takes the shape of Wales
#   - Axes labels (coords) indicates CRS is correct for Wales
emergency_services |> 
  ggplot() +
  geom_sf() +
  theme_minimal()

# Just geographr boundaries:
#   - Takes the shape of Wales
#   - Axes labels (coords) indicates CRS is correct for Wales
boundaries_wales |> 
  ggplot() +
  geom_sf() +
  theme_minimal()

# Plot osm points & geographr boundaries
emergency_services |> 
  ggplot() +
  geom_sf() +
  geom_sf(data = boundaries_wales) +
  theme_minimal()

# Reverse order of the geom plots and voila!
boundaries_wales |> 
  ggplot() +
  geom_sf() +
  geom_sf(data = emergency_services) +
  theme_minimal()