library(tidyverse)
library(geographr)

# Load z-scores for each vulnerability indicator
caci_vulnerability <-
  read_csv(
    "data/on-disk/caci/vul_zscores.csv"
  )

postcode_lookup <-
  read_csv(
    "data/on-disk/postcode_lookup.csv"
  ) |>
  select(
    postcode = pcds,
    lsoa_code = lsoa11cd
  ) |>
  mutate(postcode = str_remove_all(postcode, " "))

living_in_care_establishments <-
  caci_vulnerability |>
  select(
    postcode,
    proportion_residing_in_hospitals_or_care_homes_z = vul_hlt_com
  ) |>
  mutate(postcode = str_remove_all(postcode, " ")) |>
  left_join(postcode_lookup) |>
  filter(str_detect(lsoa_code, "^W")) |>
  group_by(lsoa_code) |>
  summarise(proportion_residing_in_hospitals_or_care_homes_z = sum(proportion_residing_in_hospitals_or_care_homes_z, na.rm = TRUE)) |>
  ungroup()

# Save
living_in_care_establishments |>
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/wales/ability-to-respond/living-in-care-establishments-lsoa.rds")

living_in_care_establishments |>
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/wales/ability-to-recover/living-in-care-establishments-lsoa.rds")