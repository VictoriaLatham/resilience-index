library(tidyverse)
library(statswalesr)

raw <-
  statswales_get_dataset("wimd1909")

cleaned <-
  raw |>
  as_tibble() |>
  select(
    lsoa_code = LSOA_Code,
    indicator = Indicator_ItemName_ENG,
    value = Data
  ) |>
  pivot_wider(
    names_from = "indicator",
    values_from = value
  ) |>
  filter(str_detect(lsoa_code, "^W01")) # Remove Wales total

illness_disability_indicators <-
  cleaned |>
  select(
    lsoa_code,
    limiting_ilness = `Limiting long-term illness (rate per 100)`,
    gp_chronic_condition = `GP-recorded chronic condition (rate per 100)`
  )

illness_disability <-
  illness_disability_indicators |>
  normalise_indicators() |>
  rowwise() |>
  mutate(
    illness_disability_normalised_score = mean(
      c(limiting_ilness, gp_chronic_condition)
    )
  ) |>
  ungroup() |>
  select(
    lsoa_code,
    illness_disability_normalised_score
  )

illness_disability %>%
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/wales/susceptibility/illness-disability-lsoa.rds")