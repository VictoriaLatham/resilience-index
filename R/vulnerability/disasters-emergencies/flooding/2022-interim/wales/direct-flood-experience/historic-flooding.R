# ---- Load ----
library(tidyverse)
library(sf)

source("R/utils.R")

# ---- Download historical flood boundaries ----
file <-
  download_file(
    "https://storage-eu-200.sharefile.com/download.ashx?dt=dt10373c4865894b89a456d749e09ea146&cid=FaGlLgAqJV4t81IQxelH7w&zoneid=zpc3159d90-01f7-41a7-a8ab-3704157466&exp=1646752606&zsid=FB&h=W6D56YcINyduQvLi89XVDPU8D3iSwi3kNsKcdZhX8kQ%3D",
    ".zip"
  )

unzip(file, exdir = tempdir())

flooding_raw <-
  read_sf(
    list.files(tempdir(),
      pattern = "NRW_RECORDED_FLOOD_EXTENTS.shp",
      full.names = TRUE
    )
  )

# Convert projection
historic_flooding <-
  flooding_raw |>
  st_transform(crs = 4326)

# ---- Load Output Area boundaries ----
# Source: https://geoportal.statistics.gov.uk/datasets/ons::output-areas-december-2011-boundaries-ew-bfe/about
# Opening straight from the web takes far too long, so load from disk:
boundaries_oa <-
  read_sf(
    "data/on-disk/oa-boundaries.geojson"
  )

flood_oa_shape <-
  boundaries_oa |>
  st_transform(crs = st_crs(historic_flooding)) |>
  st_join(historic_flooding)

# TODO:
# 1. st_join() above throws an error.
# 2. Do the dates needs filtering the previous 75 years?