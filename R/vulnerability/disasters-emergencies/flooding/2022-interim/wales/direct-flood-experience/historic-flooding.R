# ---- Load ----
library(tidyverse)
library(readxl)
library(sf)

source("R/utils.R")

# ---- OA populations ----
file <-
  download_file(
    "https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fpopulationandmigration%2fpopulationestimates%2fdatasets%2fcensusoutputareaestimatesinwales%2fmid2019sape22dt10j/sape22dt10jmid2019wales.zip",
    ".zip"
  )

unzip(file, exdir = tempdir())

oa_raw <-
  read_excel(
    list.files(
      tempdir(),
      pattern = "SAPE22DT10j-mid-2019-coa-unformatted-syoa-estimates-wales.xlsx",
      full.names = TRUE
    ),
    sheet = "Mid-2019 Persons",
    skip = 4
  )

population_oa <-
  oa_raw |>
  select(
    oa_code = OA11CD,
    lsoa_code = LSOA11CD,
    total_population = `All Ages`
  )

# ---- LSOA Population ----
file <-
  download_file(
    "https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fpopulationandmigration%2fpopulationestimates%2fdatasets%2flowersuperoutputareamidyearpopulationestimates%2fmid2020sape23dt2/sape23dt2mid2020lsoasyoaestimatesunformatted.xlsx",
    "xlsx"
  )

lsoa_raw <- read_excel(
  file,
  sheet = "Mid-2020 Persons",
  skip = 3
)

population_lsoa <-
  lsoa_raw |>
  select(
    lsoa_code = `LSOA Code`,
    total_population = `All Ages`
  )

# ---- Download historical flood boundaries ----
file <-
  download_file(
    "https://storage-eu-200.sharefile.com/download.ashx?dt=dt177205e0457440c288a7e6e18400fba5&cid=X29yCKJubJAbimuW_yH4xg&zoneid=zpc3159d90-01f7-41a7-a8ab-3704157466&exp=1646839479&zsid=FB&h=d7ag%2FUq6KjBIhgEYWZcub3WVUQY1vDZW%2BiYvIL7KHss%3D",
    ".zip"
  )

unzip(file, exdir = tempdir())

flooding_raw <-
  read_sf(
    list.files(
      tempdir(),
      pattern = "NRW_RECORDED_FLOOD_EXTENTS.shp",
      full.names = TRUE
    )
  )

# Convert projection
historic_flooding <-
  flooding_raw |>
  st_transform(crs = 4326)

# ---- Load Output Area boundaries ----
# Source: https://geoportal.statistics.gov.uk/datasets/ons::output-areas-december-2011-boundaries-ew-bfe/about
# Opening straight from the web takes far too long, so load from disk:
boundaries_oa <-
  read_sf(
    "data/on-disk/oa-boundaries.geojson"
  )

boundaries_oa_wales <-
  boundaries_oa |>
  filter(str_detect(LAD11CD, "^W")) |>
  st_transform(crs = 4326)

# https://github.com/r-spatial/sf/issues/1762
# https://r-spatial.github.io/sf/articles/sf7.html
sf_use_s2(FALSE)

flood_oa_shp <-
  boundaries_oa_wales |>
  st_join(historic_flooding)

flood_oa <-
  flood_oa_shp |>
  st_drop_geometry() |>
  filter(!is.na(Layer)) |>
  select(oa_code = OA11CD)

# ---- Look up number of people in each OA that has been historically flooded ----
flood_lsoa <-
  flood_oa |>
  left_join(population_oa) |>
  group_by(lsoa_code) |>
  summarise(people_flooded = sum(total_population)) |>
  ungroup() |>
  left_join(population_lsoa) |>
  mutate(proportion_people_flooded = people_flooded / total_population) |>
  select(
    lsoa_code, proportion_people_flooded
  )

# Save
flood_lsoa |>
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/wales/community-support/people-flooded-lsoa.rds")