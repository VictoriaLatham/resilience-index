library(tidyverse)
library(readxl)

source("R/utils.R")

file <-
  download_file(
    "https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fpopulationandmigration%2fpopulationestimates%2fdatasets%2flowersuperoutputareamidyearpopulationestimates%2fmid2020sape23dt2/sape23dt2mid2020lsoasyoaestimatesunformatted.xlsx",
    "xlsx"
  )

raw <- read_excel(
  file,
  sheet = "Mid-2020 Persons",
  skip = 3
)

primary_school_children_lsoa <-
  raw |>
  filter(str_detect(`LSOA Code`, "^W")) |>
  select(-starts_with("LA"), -`LSOA Name`) |>
  rename(lsoa_code = `LSOA Code`) |>
  pivot_longer(cols = `0`:`90+`, names_to = "age", values_to = "n_people") |>
  mutate(age = as.integer(str_extract(age, "[0-9]+"))) |>
  group_by(lsoa_code) |>
  summarise(
    num_people = sum(n_people),
    num_primary_school = sum(n_people[age >= 4 & age <= 11], na.rm = TRUE)
  ) |>
  mutate(proportion_primary_school_age = num_primary_school / num_people) |>
  select(lsoa_code, proportion_primary_school_age)

primary_school_children_lsoa |>
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/wales/community-support/primary-school-children-lsoa.rds")