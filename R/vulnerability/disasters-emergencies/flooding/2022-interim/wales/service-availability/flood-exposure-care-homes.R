# ---- Load ----
library(tidyverse)
library(readxl)
library(osmdata)
library(sf)
library(geographr)

source("R/utils.R")

lookup_postcode_oa_wales <-
  lookup_postcode_oa11_lsoa11_msoa11_ltla20 |>
  select(postcode, oa_code = oa11_code) |>
  filter(str_detect(oa_code, "^W"))

lookup_oa_lad_wales <-
  lookup_postcode_oa11_lsoa11_msoa11_ltla20 |>
  select(oa_code = oa11_code, lad_code = ltla20_code) |>
  distinct(oa_code, lad_code) |>
  filter(str_detect(oa_code, "^W"))

lookup_lsoa_lad_wales <-
  lookup_postcode_oa11_lsoa11_msoa11_ltla20 |>
  select(lsoa_code = lsoa11_code, lad_code = ltla20_code) |>
  distinct(lsoa_code, lad_code) |>
  filter(str_detect(lad_code, "^W"))

# ---- Load Flood Risk Areas ----
flood_risk_oa <-
  read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-output-areas.rds")

flood_risk_oa <-
  flood_risk_oa |>
  filter(str_detect(oa_code, "^W"))

# ---- Load Care Homes ----
care_homes_raw <-
  read_excel(
    "data/on-disk/wales-care-homes.xlsx",
    sheet = "care homes",
    skip = 3
  )

# Check oldest date is still valid
# Oldest date: "2016-10-26"
care_homes_raw |>
  select(`Latest Inspection Report Publication Date`) |>
  drop_na() |>
  pull() |>
  range()

# Keep cols of interest
care_homes_select <-
  care_homes_raw |>
  select(
    service_name = `Service Name`,
    service_type = `Service Sub Type`,
    street = `Service Address Line 1`,
    postcode = `Service Address Postcode`,
    local_authority = `Local Authority`,
    provider = `Provider Name`
  )

# Note that 273/1304 (20.1%) of postcodes are missing
care_homes_select |>
  select(postcode) |>
  keep_na() |>
  pull() |>
  length()

# The missing values all come from care homes that cater for children
# These postcodes are presumed missing for child protection reasons
care_homes_select |>
  keep_na() |>
  count(service_type)

# Drop NA
care_homes_drop_na <-
  care_homes_select |>
  drop_na()

# Some postcodes appear > 1 times
duplicate_postcodes <-
  care_homes_drop_na |>
  count(postcode, sort = TRUE) |>
  filter(n > 1) |>
  pull(postcode)

# Inspect these values
# Manually checking random duplicated on https://www.carehome.co.uk/ reveals
# That many appear to be indpendent care homes in/on the same area/street
care_homes_drop_na |>
  filter(postcode %in% duplicate_postcodes) |>
  arrange(postcode) |>
  View()

# # ---- Compare alternate OSM dataset ----
# # - Prep OSM data -
# wales_bb <- getbb("Wales")

# care_home <-
#   opq(wales_bb, timeout = 1000) %>%
#   add_osm_feature("amenity", "care_home") %>%
#   osmdata_sf()

# nursing_home <-
#   opq(wales_bb, timeout = 1000) %>%
#   add_osm_feature("amenity", "nursing_home") %>%
#   osmdata_sf()

# all_homes <-
#   bind_rows(
#     nursing_home$osm_points,
#     care_home$osm_points
#   ) |>
#   select(osm_id, name)

# # - Map care home data to oa boundaries for approx coverage -
# care_oa <-
#   care_homes_drop_na |>
#   mutate(postcode = str_remove_all(postcode, " ")) |>
#   left_join(lookup_postcode_oa_wales)

# boundaries_oa <-
#   read_sf(
#     "https://opendata.arcgis.com/datasets/a76b2f87057b43d989d8f01733104d62_0.geojson"
#   )

# care_boundaries_oa <-
#   boundaries_oa |>
#   left_join(care_oa, by = c("OA11CD" = "oa_code")) |>
#   filter(!is.na(postcode))

# # - Compare data coverage -
# ggplot() +
#   geom_sf(
#     data = care_boundaries_oa,
#     fill = NA
#   ) +
#   geom_sf(
#     data = all_homes,
#     alpha = .5,
#     size = 3
#   ) +
#   theme_minimal()

care_home_postcodes <-
  care_homes_drop_na |>
  mutate(postcode = str_remove_all(postcode, " ")) |>
  select(postcode)

care_homes_flood_risk_oa <-
  care_home_postcodes |>
  left_join(lookup_postcode_oa_wales) |>
  count(oa_code) |>
  left_join(flood_risk_oa)

# ---- Aggregate into Local Authorities ----
# Calculate proportion of schools at risk of flooding in each LA
care_homes_flood_risk_lad <-
  care_homes_flood_risk_oa |>
  left_join(lookup_oa_lad_wales) |>
  group_by(lad_code, flood_risk) |>
  summarise(n = sum(n)) |>
  ungroup() |>
  pivot_wider(names_from = flood_risk, values_from = n) |>
  mutate(proportion_schools_flood_risk = `TRUE` / (`TRUE` + `FALSE`)) |>
  select(lad_code, proportion_schools_flood_risk)

# ---- Assign the LA-level proportions to constituent LSOAs ----
care_homes_flood_risk_lsoa <-
  lookup_lsoa_lad_wales |>
  left_join(care_homes_flood_risk_lad) |>
  select(-lad_code)

# Save
care_homes_flood_risk_lsoa %>%
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/wales/community-support/flooding-exposure-care-homes-lsoa.rds")

care_homes_flood_risk_lad %>%
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/wales/community-support/flooding-exposure-care-homes-lad.rds")