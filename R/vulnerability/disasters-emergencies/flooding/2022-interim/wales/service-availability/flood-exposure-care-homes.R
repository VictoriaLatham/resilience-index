# ---- Load ----
library(tidyverse)
library(readxl)
library(osmdata)
library(sf)
library(geographr)

source("R/utils.R")

lookup_postcode_oa_wales <-
  lookup_postcode_oa11_lsoa11_msoa11_ltla20 |>
  select(postcode, oa_code = oa11_code) |>
  filter(str_detect(oa_code, "^W"))

lookup_oa_lad_wales <-
  lookup_postcode_oa11_lsoa11_msoa11_ltla20 |>
  select(oa_code = oa11_code, lad_code = ltla20_code) |>
  distinct(oa_code, lad_code) |>
  filter(str_detect(oa_code, "^W"))

lookup_lsoa_lad_wales <-
  lookup_postcode_oa11_lsoa11_msoa11_ltla20 |>
  select(lsoa_code = lsoa11_code, lad_code = ltla20_code) |>
  distinct(lsoa_code, lad_code) |>
  filter(str_detect(lad_code, "^W"))

# ---- Load Flood Risk Areas ----
flood_risk_oa <-
  read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-output-areas.rds")

flood_risk_oa <-
  flood_risk_oa |>
  filter(str_detect(oa_code, "^W"))

# ---- Load Care Homes ----
care_homes_raw <-
  read_excel(
    "data/on-disk/wales-care-homes.xlsx",
    sheet = "care homes",
    skip = 3
  )

# Check oldest date is still valid
# Oldest date: "2016-10-26"
care_homes_raw |>
  select(`Latest Inspection Report Publication Date`) |>
  drop_na() |>
  pull() |>
  range()

# Keep cols of interest
care_homes_select <-
  care_homes_raw |>
  select(
    service_name = `Service Name`,
    service_type = `Service Sub Type`,
    street = `Service Address Line 1`,
    postcode = `Service Address Postcode`,
    local_authority = `Local Authority`,
    provider = `Provider Name`
  )

# Note that 273/1304 (20.1%) of postcodes are missing
care_homes_select |>
  select(postcode) |>
  keep_na() |>
  pull() |>
  length()

# The missing values all come from care homes that cater for children
# These postcodes are presumed missing for child protection reasons
care_homes_select |>
  keep_na() |>
  count(service_type)

# Drop NA
care_homes_drop_na <-
  care_homes_select |>
  drop_na()

# Some postcodes appear > 1 times
duplicate_postcodes <-
  care_homes_drop_na |>
  count(postcode, sort = TRUE) |>
  filter(n > 1) |>
  pull(postcode)

# Inspect these values
# Manually checking random duplicated on https://www.carehome.co.uk/ reveals
# That many appear to be indpendent care homes in/on the same area/street
care_homes_drop_na |>
  filter(postcode %in% duplicate_postcodes) |>
  arrange(postcode) |>
  print(n = Inf)

wales_bb <- getbb("Wales")

care_home <-
  opq(wales_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "care_home") %>%
  osmdata_sf()

nursing_home <-
  opq(wales_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "nursing_home") %>%
  osmdata_sf()

# Check CRS matches geographr
all_homes <-
  bind_rows(
    nursing_home$osm_points,
    care_home$osm_points
  ) |>
  select(osm_id, name)

all_homes_crs <-
  all_homes |>
  st_crs()

boundaires_ltla21_crs <-
  boundaries_ltla21 |> 
  st_crs()

if(all_homes_crs != boundaires_ltla21_crs){
  stop("CRS projects do not align")
}

# When the car_homes points are plotted, they take the shape of wales
all_homes |>
  ggplot() +
  geom_sf() +
  geom_sf(
    data = boundaries_ltla21 |> filter(str_detect(ltla21_code, "^W"))
  ) +
  theme_map()




geographr::boundaries_ltla21 |> st_crs()