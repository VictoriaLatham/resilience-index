# ---- Load ----
library(tidyverse)
library(readxl)
library(osmdata)
library(sf)
library(geographr)

source("R/utils.R")

lookup_postcode_oa_wales <-
  lookup_postcode_oa_11_lsoa_11_msoa_11_lad_20 |>
  select(postcode, oa_code = oa_11_code) |>
  filter(str_detect(oa_code, "^W"))

lookup_oa_lad_wales <-
  lookup_postcode_oa_11_lsoa_11_msoa_11_lad_20 |>
  select(oa_code = oa_11_code, lad_code = lad_20_code) |>
  distinct(oa_code, lad_code) |>
  filter(str_detect(oa_code, "^W"))

lookup_lsoa_lad_wales <-
  lookup_postcode_oa_11_lsoa_11_msoa_11_lad_20 |>
  select(lsoa_code = lsoa_11_code, lad_code = lad_20_code) |>
  distinct(lsoa_code, lad_code) |>
  filter(str_detect(lad_code, "^W"))

# ---- Load Flood Risk Areas ----
flood_risk_oa <-
  read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-output-areas.rds")

flood_risk_oa <-
  flood_risk_oa |>
  filter(str_detect(oa_code, "^W"))

# ---- Load GP Surgery Locations ----
# https://gov.wales/gp-access-2019
# Use annex tables
raw <-
  download_file(
    "https://nwssp.nhs.wales/ourservices/primary-care-services/primary-care-services-documents/gp-practice-analysis-docs/gp-practice-analysis-2021",
    ".xlsx"
  )

gp_surgeries <-
  read_excel(
    raw,
    sheet = "2021"
  )

gp_postcodes <-
  gp_surgeries |>
  select(postcode = Postcode) |>
  mutate(
    postcode = str_remove_all(postcode, " ")
  )

gp_surgeries_flood_risk <-
  gp_postcodes |>
  left_join(lookup_postcode_oa_wales) |>
  count(oa_code) |>
  left_join(flood_risk_oa) |>
  drop_na()

# ---- Aggregate into Local Authorities ----
# Calculate proportion of GP surgeries at risk of flooding in each LA
gp_surgeries_flood_risk_lad <-
  gp_surgeries_flood_risk |>
  left_join(lookup_oa_lad_wales) |>
  group_by(lad_code, flood_risk) |>
  summarise(n = sum(n)) |>
  ungroup() |>
  pivot_wider(names_from = flood_risk, values_from = n) |>
  mutate(proportion_gp_surgeries_flood_risk = `TRUE` / (`TRUE` + `FALSE`)) |>
  select(lad_code, proportion_gp_surgeries_flood_risk)

# ---- Assign the LA-level proportions to constituent LSOAs ----
gp_surgeries_flood_risk_lsoa <-
  lookup_lsoa_lad_wales |>
  left_join(gp_surgeries_flood_risk_lad) |>
  select(-lad_code)

# Save
gp_surgeries_flood_risk_lsoa |>
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/wales/community-support/flooding-exposure-gp-surgeries-lsoa.rds")

gp_surgeries_flood_risk_lad |>
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/wales/community-support/flooding-exposure-gp-surgeries-lad.rds")