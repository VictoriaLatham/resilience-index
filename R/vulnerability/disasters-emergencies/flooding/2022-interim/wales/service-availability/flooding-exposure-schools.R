# ---- Load ----
library(tidyverse)
library(readODS)
library(osmdata)
library(sf)
library(geographr)

source("R/utils.R")

lookup_postcode_oa_wales <-
  lookup_postcode_oa11_lsoa11_msoa11_ltla20 |>
  select(postcode, oa_code = oa11_code) |>
  filter(str_detect(oa_code, "^W"))

lookup_oa_lad_wales <-
  lookup_postcode_oa11_lsoa11_msoa11_ltla20 |>
  select(oa_code = oa11_code, lad_code = ltla20_code) |>
  distinct(oa_code, lad_code) |>
  filter(str_detect(oa_code, "^W"))

lookup_lsoa_lad_wales <-
  lookup_postcode_oa11_lsoa11_msoa11_ltla20 |>
  select(lsoa_code = lsoa11_code, lad_code = ltla20_code) |>
  distinct(lsoa_code, lad_code) |>
  filter(str_detect(lad_code, "^W"))

# ---- Load Flood Risk Areas ----
flood_risk_oa <-
  read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-output-areas.rds")

flood_risk_oa <-
  flood_risk_oa |>
  filter(str_detect(oa_code, "^W"))

# ---- Load School Locations ----
raw <-
  download_file(
    "https://gov.wales/sites/default/files/publications/2022-01/address-list-schools-wales.ods",
    ".ods"
  )

schools_maintained <-
  read_ods(
    raw,
    sheet = "Maintained"
  ) |>
  as_tibble()

schools_independent <-
  read_ods(
    raw,
    sheet = "Independent"
  ) |>
  as_tibble()

schools_pru <-
  read_ods(
    raw,
    sheet = "PRU"
  ) |>
  as_tibble()

schools_maintained_select <-
  schools_maintained |>
  select(
    school_no = `School Number`,
    postcode = Postcode
  )

schools_independent_select <-
  schools_independent |>
  select(
    school_no = `School Number`,
    postcode = Postcode
  ) |>
  mutate(
    postcode = if_else(
      is.na(postcode),
      "SA13 3PB",
      postcode
    )
  )

schools_pru_select <-
  schools_pru |>
  select(
    school_no = `School Number`,
    postcode = Postcode
  )

schools_postcodes <-
  bind_rows(
    schools_maintained_select,
    schools_independent_select,
    schools_pru_select
  ) |>
  distinct(school_no, postcode) |>
  select(-school_no) |>
  mutate(
    postcode = str_remove_all(postcode, " ")
  )

schools_flood_risk_oa <-
  schools_postcodes |>
  left_join(lookup_postcode_oa_wales) |>
  count(oa_code) |>
  left_join(flood_risk_oa) |>
  drop_na()

# ---- Aggregate into Local Authorities ----
# Calculate proportion of schools at risk of flooding in each LA
schools_flood_risk_lad <-
  schools_flood_risk_oa |>
  left_join(lookup_oa_lad_wales) |>
  group_by(lad_code, flood_risk) |>
  summarise(n = sum(n)) |>
  ungroup() |>
  pivot_wider(names_from = flood_risk, values_from = n) |>
  mutate(proportion_schools_flood_risk = `TRUE` / (`TRUE` + `FALSE`)) |>
  select(lad_code, proportion_schools_flood_risk)

# ---- Assign the LA-level proportions to constituent LSOAs ----
schools_flood_risk_lsoa <-
  lookup_lsoa_lad_wales |>
  left_join(schools_flood_risk_lad) |>
  select(-lad_code)

# Save
schools_flood_risk_lsoa %>%
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/wales/community-support/flooding-exposure-schools-lsoa.rds")

schools_flood_risk_lad %>%
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/wales/community-support/flooding-exposure-schools-lad.rds")