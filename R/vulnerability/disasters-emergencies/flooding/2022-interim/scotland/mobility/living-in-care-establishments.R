# Load packages
library(dplyr)
library(readr)
library(stringr)
library(demographr)
library(geographr)

# Load z-scores for each vulnerability indicator
caci_vulnerability <-
  read_csv(
    "data/on-disk/CACI/vul_zscores.csv"
  )

living_in_care_establishments <-
  caci_vulnerability |>
  select(
    postcode,
    proportion_residing_in_hospitals_or_care_homes_z = vul_hlt_com
  ) |>
  mutate(postcode = gsub(" ", "", postcode)) |>
  left_join(lookup_postcode_oa_lsoa_msoa_lad_20, by = "postcode") |>
  group_by(lsoa_code) |>
  summarise(proportion_residing_in_hospitals_or_care_homes_z = sum(proportion_residing_in_hospitals_or_care_homes_z, na.rm = TRUE)) |>
  ungroup()

# Keep only Scotland
living_in_care_establishments <-
  living_in_care_establishments |>
  filter(str_detect(lsoa_code, "^S")) |>
  rename(dz_code = lsoa_code)

# Save
living_in_care_establishments |>
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/scotland/ability-to-respond/living-in-care-establishments-dz.rds")

living_in_care_establishments |>
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/scotland/ability-to-recover/living-in-care-establishments-lsoa.rds")
