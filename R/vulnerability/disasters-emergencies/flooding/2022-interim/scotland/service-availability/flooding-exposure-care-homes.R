# Load packages 
library(dplyr)
library(readr)
library(geographr)
library(stringr)
library(tidyr)
library(demographr)

# Need flood risk OAs for Scotland - below code won't work until then
#flood_risk_oa <- read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-output-areas.rds")

# Source: https://www.careinspectorate.com/index.php/statistics-and-analysis/data-and-analysis
care_homes <- read_csv("https://www.careinspectorate.com/images/documents/coronavirus/MDSF_data_31_March_2020_1.csv")

care_homes_flood_risk_oa <- 
  care_homes |> 
  filter(CareService == "Care Home Service",
         ServiceStatus == "Active") |>
  select(postcode = Service_Postcode) |> 
  mutate(postcode = gsub(" ", "", postcode)) |> 
  left_join(lookup_postcode_oa_lsoa_msoa_lad_20, by = "postcode") |> 
  count(oa_code) |> 
  left_join(flood_risk_oa)


# ---- Aggregate into Local Authorities ----
oa_lad <- 
  lookup_postcode_oa_lsoa_msoa_lad_20 |> 
  distinct(oa_code, lad_code)

# Calculate proportion of GP surgeries at risk of flooding in each LA
care_homes_flood_risk_lad <- 
  care_homes_flood_risk_oa |> 
  left_join(oa_lad) |> 
  
  group_by(lad_code, flood_risk) |> 
  summarise(n = sum(n)) |> 
  ungroup() |> 
  
  pivot_wider(names_from = flood_risk, values_from = n) |> 
  mutate(proportion_care_homes_flood_risk = `TRUE` / (`TRUE` + `FALSE`)) |> 
  
  select(lad_code, proportion_care_homes_flood_risk)

# ---- Assign the LA-level proportions to constituent LSOAs ----
care_homes_flood_risk_dz <- 
  lookup_postcode_oa_lsoa_msoa_lad |> 
  distinct(lsoa_code, lad_code) |> 
  filter(str_detect(lsoa_code, "^S")) |> 
  
  left_join(care_homes_flood_risk_lad) |> 
  select(-lad_code) |>
  rename(dz_code = lsoa_code)

# Save
care_homes_flood_risk_dz |> 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/scotland/community-support/flooding-exposure-care-homes-dz.rds")

care_homes_flood_risk_lad |> 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/scotland/community-support/flooding-exposure-care-homes-lad.rds")
