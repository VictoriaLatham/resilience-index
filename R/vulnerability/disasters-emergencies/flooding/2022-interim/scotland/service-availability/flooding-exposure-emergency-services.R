# Load packages 
library(dplyr)
library(readr)
library(readxl)
library(osmdata)
library(sf)
library(geographr)

source("R/utils.R") # for download_file()

# Need flood risk OAs for Scotland - below code won't work until then
#flood_risk_oa <- read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-output-areas.rds")

# OA to DataZone lookup ----
# Source: https://www.nrscotland.gov.uk/statistics-and-data/geography/our-products/census-datasets/2011-census/2011-indexes
# 'Output Area 2011 to Data Zones and Intermediate Zones 2011' file
tf <- download_file("https://www.nrscotland.gov.uk/files//geography/2011-census/OA_DZ_IZ_2011.xlsx", ".xlsx")

oa_dz_lookup <- read_excel(tf)


#  Load Output Area boundaries ----
# Source: https://www.nrscotland.gov.uk/statistics-and-data/geography/our-products/census-datasets/2011-census/2011-boundaries
# 'Extent of the Realm' file
tf <- download_file("https://www.nrscotland.gov.uk/files/geography/output-area-2011-eor.zip", "zip")

unzip(tf, exdir = tempdir())

raw_boundaries <- read_sf(paste0(tempdir(), 
                                 "/OutputArea2011_EoR.shp"))

boundaries_oa <- raw_boundaries |>
  select(oa_code = code, council, geometry) 

# ---- Get map points for each type of emergency service ----
# Bounding box for Scotland
scotland_bb <- getbb("Scotland")

fire <- 
  opq(scotland_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "fire_station") %>%
  osmdata_sf()

police <- 
  opq(scotland_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "police") %>%
  osmdata_sf()

ambo <- 
  opq(scotland_bb, timeout = 1000) %>%
  add_osm_feature("emergency", "ambulance_station") %>%
  osmdata_sf()

emergency_services <- 
  bind_rows(
    fire$osm_points,
    police$osm_points,
    ambo$osm_points,
    .id = "service"
  ) %>% 
  select(osm_id, name, service) %>%
  mutate(service = recode(service, 
                          `1` = "fire", 
                          `2` = "police", 
                          `3` = "ambo"))

# Convert to projected CRS for checking intersection on 2D plane
emergency_services_proj <- st_transform(emergency_services, crs = st_crs(boundaries_oa))

# ---- Get Output Areas for each emergency service ----
emergency_services_oa <- 
  emergency_services_proj %>% 
  st_join(boundaries_oa) 

# Check those with no OA match - are in NI & England (picked up do to boundary box in line 39)
emergency_services_oa |>
  mutate(no_oa_match = if_else(is.na(oa_code), T, F)) |>
  ggplot() + 
  geom_sf(aes(colour = no_oa_match))

# Checks of number of each service 
emergency_services_oa %>%
  st_drop_geometry() %>% 
  filter(is.na(oa_code)) %>%
  group_by(service) %>%
  summarise(count = n())

emergency_services_oa <- 
  emergency_services_oa %>% 
  st_drop_geometry() %>% 
  as_tibble() %>% 
  count(oa_code)

# emergency_services_oa %>% 
#   write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/flooding-exposure-emergency-services-oa.rds")
# 
# emergency_services_oa <-
#   read_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/flooding-exposure-emergency-services-oa.rds")

# Which OAs are in flood risk areas?
emergency_services_flood_risk_oa <- 
  emergency_services_oa %>% 
  left_join(flood_risk_oa)

# ---- Aggregate into Local Authorities ----
oa_lad <- 
  lookup_postcode_oa_lsoa_msoa_lad %>% 
  distinct(oa_code, lad_code)

# Calculate proportion of emergency services at risk of flooding in each LA
emergency_services_flood_risk_lad <- 
  emergency_services_flood_risk_oa %>% 
  left_join(oa_lad) %>% 
  
  group_by(lad_code, flood_risk) %>% 
  summarise(n = sum(n)) %>% 
  ungroup() %>% 
  
  pivot_wider(names_from = flood_risk, values_from = n) %>% 
  mutate(proportion_emergency_services_flood_risk = `TRUE` / (`TRUE` + `FALSE`)) %>% 
  
  select(lad_code, proportion_emergency_services_flood_risk)

# ---- Assign the LA-level proportions to constituent LSOAs ----
emergency_services_flood_risk_lsoa <- 
  lookup_postcode_oa_lsoa_msoa_lad %>% 
  distinct(lsoa_code, lad_code) %>% 
  filter(str_detect(lsoa_code, "^E")) %>% 
  
  left_join(emergency_services_flood_risk_lad) %>% 
  select(-lad_code)

# Save
emergency_services_flood_risk_lsoa %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/community-support/flooding-exposure-emergency-services-lsoa.rds")

emergency_services_flood_risk_lad %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/england/community-support/flooding-exposure-emergency-services-lad.rds")
