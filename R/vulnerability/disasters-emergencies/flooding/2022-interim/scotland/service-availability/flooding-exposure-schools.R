# Load packages 
library(dplyr)
library(readr)
library(geographr)
library(stringr)

source("R/utils.R") #for download_file()

# Need flood risk OAs for Scotland - below code won't work until then
#flood_risk_oa <- read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-output-areas.rds")

# Scottish school data -----
# Source: https://data.gov.uk/dataset/9a6f9d86-9698-4a5d-a2c8-89f3b212c52c/scottish-school-roll-and-locations
tf <- download_file("https://maps.gov.scot/ATOM/shapefiles/SG_SchoolRoll_2021.zip", "zip")

unzip(tf, exdir = tempdir())

schools <- read_sf(paste0(tempdir(), 
                             "/SG_SchoolRoll_2021/SG_SchoolRoll_2021.shp"))


# Get each school's Output Area - how many schools are in Output Areas at risk of flooding?
schools_flood_risk_oa <- 
  schools %>% 
  select(postcode = PostCode) %>% 
  mutate(postcode = gsub(" ", "", postcode)) %>% 
  left_join(lookup_postcode_oa_lsoa_msoa_lad_20) %>% 
  count(oa_code) %>% 
  left_join(flood_risk_oa)

# ---- Aggregate into Local Authorities ----
oa_lad <- 
  lookup_postcode_oa_lsoa_msoa_lad %>% 
  distinct(oa_code, lad_code)

# Calculate proportion of GP surgeries at risk of flooding in each LA
schools_flood_risk_lad <- 
  schools_flood_risk_oa %>% 
  left_join(oa_lad) %>% 
  
  group_by(lad_code, flood_risk) %>% 
  summarise(n = sum(n)) %>% 
  ungroup() %>% 
  
  pivot_wider(names_from = flood_risk, values_from = n) %>% 
  mutate(proportion_schools_flood_risk = `TRUE` / (`TRUE` + `FALSE`)) %>% 
  
  select(lad_code, proportion_schools_flood_risk)

# ---- Assign the LA-level proportions to constituent LSOAs ----
schools_flood_risk_dz <- 
  lookup_postcode_oa_lsoa_msoa_lad %>% 
  distinct(lsoa_code, lad_code) %>% 
  filter(str_detect(lsoa_code, "^S")) %>% 
  
  left_join(schools_flood_risk_lad) %>% 
  select(-lad_code) |>
  rename(dz_code = lsoa_code)

# Save
schools_flood_risk_dz %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/scotland/community-support/flooding-exposure-schools-dz.rds")

schools_flood_risk_lad %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/scotland/community-support/flooding-exposure-schools-lad.rds")
