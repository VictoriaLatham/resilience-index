library(dplyr)
library(readr)
library(geographr)
library(stringr)
library(tidyr)

# Load flood risk Small Areas
flood_risk_sa <- read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-small-areas.rds")

# Prep postcode to SOA lookup
# Manually downloaded postcode directory from https://geoportal.statistics.gov.uk/datasets/ons-postcode-directory-february-2022/about
# and just loading the Northern Ireland (BTx xxx) postcodes
postcodes_ni <- read_csv("data/ONSPD_FEB_2022_UK_BT.csv")

postcodes_ni <- 
  postcodes_ni %>% 
  select(postcode = pcd, sa_code = oa11, soa_code = lsoa11) %>% 
  mutate(postcode = gsub(" ", "", postcode))

# Locations regulated by RQIA: https://www.opendatani.gov.uk/dataset/rqia-registered-services/resource/159539b2-b43e-4066-a213-be5c3b27fdab
care_homes <- read_csv("https://www.opendatani.gov.uk/dataset/738792e7-26bc-485b-aa67-e933207ef6f3/resource/159539b2-b43e-4066-a213-be5c3b27fdab/download/rqia-registered-services.csv")

care_homes_flood_risk_sa <- 
  care_homes %>% 
  filter(`Service Type` == "Residential (RC)") %>% 
  select(postcode = Postcode) %>% 
  mutate(postcode = gsub(" ", "", postcode)) %>% 
  left_join(postcodes_ni) %>% 
  count(sa_code) %>% 
  left_join(flood_risk_sa)

# ---- Aggregate into Local Authorities ----
# Calculate proportion of GP surgeries at risk of flooding in each LA
care_homes_flood_risk_lad <- 
  care_homes_flood_risk_sa %>% 
  left_join(geographr::lookup_sa_soa_lgd, by = "sa_code") %>% 
  
  mutate(flood_risk = replace_na(flood_risk, FALSE)) %>% 
  
  group_by(lgd_code, flood_risk) %>% 
  summarise(n = sum(n)) %>% 
  ungroup() %>% 
  
  pivot_wider(names_from = flood_risk, values_from = n) %>% 
  mutate(proportion_care_homes_flood_risk = `TRUE` / (`TRUE` + `FALSE`)) %>% 
  
  select(lgd_code, proportion_care_homes_flood_risk)

# ---- Assign the LA-level proportions to constituent LSOAs ----
care_homes_flood_risk_lsoa <- 
  geographr::lookup_sa_soa_lgd %>% 
  distinct(soa_code, lgd_code) %>% 
  
  left_join(care_homes_flood_risk_lad) %>% 
  select(-lgd_code)

# Save
care_homes_flood_risk_lsoa %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/northern-ireland/community-support/flooding-exposure-care-homes-lsoa.rds")

care_homes_flood_risk_lad %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/northern-ireland/community-support/flooding-exposure-care-homes-lad.rds")

