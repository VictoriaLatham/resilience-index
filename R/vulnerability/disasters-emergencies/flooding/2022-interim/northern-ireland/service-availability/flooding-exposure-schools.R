library(dplyr)
library(readr)
library(geographr)
library(stringr)
library(readxl)

source("R/utils.R")

# Load flood risk Small Areas
flood_risk_sa <- read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-small-areas.rds")

# Prep postcode to SOA lookup
# Manually downloaded postcode directory from https://geoportal.statistics.gov.uk/datasets/ons-postcode-directory-february-2022/about
# and just loading the Northern Ireland (BTx xxx) postcodes
postcodes_ni <- read_csv("data/ONSPD_FEB_2022_UK_BT.csv")

postcodes_ni <- 
  postcodes_ni %>% 
  select(postcode = pcd, sa_code = oa11, soa_code = lsoa11) %>% 
  mutate(postcode = gsub(" ", "", postcode))

# ---- Download school data ----
# Source: https://www.education-ni.gov.uk/publications/school-enrolment-school-level-data-202122

# Nursery schools
tf_schools <- download_file("https://www.education-ni.gov.uk/sites/default/files/publications/education/School%20level%20-%20nursery%20schools%20data%20-%202021_22.xlsx", ".xlsx")
schools_nursery <- read_excel(tf_schools, sheet = "reference data", skip = 2)

# Pre-school
tf_schools <- download_file("https://www.education-ni.gov.uk/sites/default/files/publications/education/School%20level%20-%20pre-school%20data%202021_22.xlsx", ".xlsx")
schools_pre <- read_excel(tf_schools, sheet = "reference data", skip = 3)

# Primary school
tf_schools <- download_file("https://www.education-ni.gov.uk/sites/default/files/publications/education/School%20level%20-%20primary%20schools%20data%202122.XLSX", ".xlsx")
schools_primary <- read_excel(tf_schools, sheet = "reference data", skip = 3)

# Special schools
tf_schools <- download_file("https://www.education-ni.gov.uk/sites/default/files/publications/education/School%20level%20-%20special%20schools%20data%202021_22.xlsx", ".xlsx")
schools_special <- read_excel(tf_schools, sheet = "Reference data", skip = 4)

# Post-primary school
tf_schools <- download_file("https://www.education-ni.gov.uk/sites/default/files/publications/education/School%20level%20-%20post%20primary%20schools%20data%202021_22.xlsx", ".xlsx")
schools_post <- read_excel(tf_schools, sheet = "reference data", skip = 3)

# Combine
schools <- 
  bind_rows(
    schools_nursery %>% select(postcode),
    schools_pre %>% select(postcode),
    schools_primary %>% select(postcode),
    schools_special %>% select(postcode),
    schools_post %>% select(postcode)
  ) %>% 
  distinct()

# Get each school's Small Area - how many schools are in Small Areas at risk of flooding?
schools_flood_risk_oa <- 
  schools %>% 
  mutate(postcode = gsub(" ", "", postcode)) %>% 
  left_join(postcodes_ni) %>% 
  count(sa_code) %>% 
  left_join(flood_risk_sa)

# ---- Aggregate into Local Authorities ----
# Calculate proportion of schools at risk of flooding in each LA
schools_flood_risk_lad <- 
  schools_flood_risk_oa %>% 
  left_join(geographr::lookup_sa_soa_lgd, by = "sa_code") %>% 
  
  mutate(flood_risk = replace_na(flood_risk, FALSE)) %>% 
  
  group_by(lgd_code, flood_risk) %>% 
  summarise(n = sum(n)) %>% 
  ungroup() %>% 
  
  pivot_wider(names_from = flood_risk, values_from = n) %>% 
  mutate(proportion_schools_flood_risk = `TRUE` / (`TRUE` + `FALSE`)) %>% 
  
  select(lgd_code, proportion_schools_flood_risk)

# ---- Assign the LA-level proportions to constituent LSOAs ----
schools_flood_risk_lsoa <- 
  geographr::lookup_sa_soa_lgd %>% 
  distinct(soa_code, lgd_code) %>% 
  
  left_join(schools_flood_risk_lad) %>% 
  select(-lgd_code)

# Save
schools_flood_risk_lsoa %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/northern-ireland/community-support/flooding-exposure-schools-lsoa.rds")

schools_flood_risk_lad %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/northern-ireland/community-support/flooding-exposure-schools-lad.rds")
