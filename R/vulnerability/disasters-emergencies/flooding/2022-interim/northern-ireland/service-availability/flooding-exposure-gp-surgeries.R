library(dplyr)
library(readr)
library(geographr)
library(stringr)
library(tidyr)

# Load flood risk Small Areas
flood_risk_sa <- read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-small-areas.rds")

# Prep postcode to SOA lookup
# Manually downloaded postcode directory from https://geoportal.statistics.gov.uk/datasets/ons-postcode-directory-february-2022/about
# and just loading the Northern Ireland (BTx xxx) postcodes
postcodes_ni <- read_csv("data/ONSPD_FEB_2022_UK_BT.csv")

postcodes_ni <- 
  postcodes_ni %>% 
  select(postcode = pcd, sa_code = oa11, soa_code = lsoa11) %>% 
  mutate(postcode = gsub(" ", "", postcode))

# Load GP surgery locations
# Source: https://www.opendatani.gov.uk/dataset/gp-practice-list-sizes
gp_surgeries <- read_csv("https://www.opendatani.gov.uk/dataset/3d1a6615-5fc9-4f0e-ab2a-d2b0d71fb9ed/resource/80b06a43-2d1f-47c2-9142-7f46e9ea6e8b/download/gp-practice-reference-file--january-2022.csv")

# Get Output Areas for each GP and see if they're at risk of flooding
gp_surgeries_flood_risk <- 
  gp_surgeries %>% 
  select(postcode = Postcode) %>% 
  mutate(postcode = gsub(" ", "", postcode)) %>% 
  left_join(postcodes_ni) %>% 
  count(sa_code) %>% 
  left_join(flood_risk_sa)

# ---- Aggregate into Local Authorities ----
# Calculate proportion of GP surgeries at risk of flooding in each LA
gp_surgeries_flood_risk_lad <- 
  gp_surgeries_flood_risk %>% 
  left_join(geographr::lookup_sa_soa_lgd, by = "sa_code") %>% 
  
  mutate(flood_risk = replace_na(flood_risk, FALSE)) %>% 
  
  group_by(lgd_code, flood_risk) %>% 
  summarise(n = sum(n)) %>% 
  ungroup() %>% 
  
  pivot_wider(names_from = flood_risk, values_from = n) %>% 
  mutate(proportion_gp_surgeries_flood_risk = `TRUE` / (`TRUE` + `FALSE`)) %>% 
  
  select(lgd_code, proportion_gp_surgeries_flood_risk)

# ---- Assign the LA-level proportions to constituent SOAs ----
gp_surgeries_flood_risk_lsoa <- 
  geographr::lookup_sa_soa_lgd %>% 
  distinct(soa_code, lgd_code) %>% 
  
  left_join(gp_surgeries_flood_risk_lad) %>% 
  select(-lgd_code)

# Save
gp_surgeries_flood_risk_lsoa %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/northern-ireland/community-support/flooding-exposure-gp-surgeries-lsoa.rds")

gp_surgeries_flood_risk_lad %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/northern-ireland/community-support/flooding-exposure-gp-surgeries-lad.rds")
