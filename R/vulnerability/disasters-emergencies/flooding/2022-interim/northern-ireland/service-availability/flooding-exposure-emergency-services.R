library(dplyr)
library(readr)
library(osmdata)
library(sf)
library(geographr)

# Load flood risk Small Areas
flood_risk_sa <- read_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-small-areas.rds")

# ---- Load Output Area boundaries ----
# Source: https://www.nisra.gov.uk/publications/small-area-boundaries-gis-format
# Opening straight from the web takes far too long, so I manually downloaded a local copy and will load from that
boundaries_sa <- read_sf("data/vulnerability/disasters-emergencies/flooding/SA2011.shp")

boundaries_sa <- st_transform(boundaries_sa, crs = 4326)

# ---- Get map points for each type of emergency service ----
# Bounding box for NI
ni_bb <- getbb("Northern Ireland")

fire <- 
  opq(ni_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "fire_station") %>%
  osmdata_sf()

police <- 
  opq(ni_bb, timeout = 1000) %>%
  add_osm_feature("amenity", "police") %>%
  osmdata_sf()

ambo <- 
  opq(ni_bb, timeout = 1000) %>%
  add_osm_feature("emergency", "ambulance_station") %>%
  osmdata_sf()

emergency_services <- 
  bind_rows(
    fire$osm_points,
    police$osm_points,
    ambo$osm_points
  ) %>% 
  select(osm_id, name)

emergency_services <- st_transform(emergency_services, crs = st_crs(boundaries_sa))

# ---- Get Output Areas for each emergency service ----
st_crs(emergency_services) <- 4326  # Need to do this to make the next block of code work - see https://stackoverflow.com/a/62268361

sf::sf_use_s2(FALSE)  # Run this line to avoid an error: Evaluation error: Found 1 feature with invalid spherical geometry (see https://stackoverflow.com/a/68481205)

emergency_services_sa <- 
  emergency_services %>% 
  st_join(boundaries_sa)

emergency_services_sa <- 
  emergency_services_sa %>% 
  st_drop_geometry() %>% 
  as_tibble() %>% 
  count(soa_code = SOA2011)

# Which OAs are in flood risk areas?
emergency_services_flood_risk_sa <- 
  emergency_services_sa %>% 
  left_join(flood_risk_sa)

# ---- Aggregate into Local Authorities ----
# Calculate proportion of emergency services at risk of flooding in each LA
emergency_services_flood_risk_lad <- 
  emergency_services_flood_risk_sa %>% 
  left_join(geographr::lookup_sa_soa_lgd, by = "soa_code") %>% 
  
  mutate(flood_risk = replace_na(flood_risk, FALSE)) %>% 
  
  group_by(lgd_code, flood_risk) %>% 
  summarise(n = sum(n)) %>% 
  ungroup() %>% 
  
  pivot_wider(names_from = flood_risk, values_from = n) %>% 
  mutate(proportion_emergency_services_flood_risk = `TRUE` / (`TRUE` + `FALSE`)) %>% 
  
  select(lgd_code, proportion_emergency_services_flood_risk)

# ---- Assign the LA-level proportions to constituent LSOAs ----
emergency_services_flood_risk_lsoa <- 
  geographr::lookup_sa_soa_lgd %>% 
  distinct(soa_code, lgd_code) %>% 
  
  left_join(emergency_services_flood_risk_lad) %>% 
  select(-lgd_code)

# Save
emergency_services_flood_risk_lsoa %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/northern-ireland/community-support/flooding-exposure-emergency-services-lsoa.rds")

emergency_services_flood_risk_lad %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/northern-ireland/community-support/flooding-exposure-emergency-services-lad.rds")
