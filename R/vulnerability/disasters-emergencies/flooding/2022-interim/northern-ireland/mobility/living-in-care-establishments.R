library(dplyr)
library(geographr)
library(readr)
source("R/utils.R")

# Prep postcode to SOA lookup
postcodes_ni <- read_csv("data/ONSPD_FEB_2022_UK_BT.csv")

postcodes_ni <- 
  postcodes_ni %>% 
  select(postcode = pcd, soa_code = lsoa11) %>% 
  mutate(postcode = gsub(" ", "", postcode))

# Load z-scores for each vulnerability indicator
caci_vulnerability <- 
  read_csv(
    "C:/Users/040026704/British Red Cross Society/Strategic Insight and Foresight - Documents/Data/CACI/vul_zscores.csv"
  )

living_in_care_establishments <- 
  caci_vulnerability %>% 
  filter(str_detect(postcode, "^BT")) %>% 
  
  select(
    postcode, 
    proportion_residing_in_hospitals_or_care_homes_z = vul_hlt_com
  ) %>% 
  
  mutate(postcode = gsub(" ", "", postcode)) %>% 
  
  left_join(postcodes_ni) %>% 
  
  group_by(soa_code) %>% 
  summarise(proportion_residing_in_hospitals_or_care_homes_z = sum(proportion_residing_in_hospitals_or_care_homes_z, na.rm = TRUE)) %>% 
  ungroup() 

# Save
living_in_care_establishments %>%
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/northern-ireland/ability-to-respond/living-in-care-establishments-lsoa.rds")

living_in_care_establishments %>%
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/northern-ireland/ability-to-recover/living-in-care-establishments-lsoa.rds")
