library(dplyr)
library(sf)
library(geographr)
library(readxl)

source("R/utils.R")  # for download_file()

# ---- Load NI flood map ----
unzip("depreciated/data/raw/floods/ni.zip", exdir = tempdir())

flood_sa <- read_sf(file.path(tempdir(), "NI small areas in flood risk zones.shp"))

# Save for future use
flood_sa %>% 
  st_drop_geometry() %>% 
  mutate(flood_risk = TRUE) %>% 
  rename(sa_code = SA2011, soa_code = SOA2011) %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-small-areas.rds")

# ---- Look up number of people in each Small Area that has been historically flooded ----
# Fetch Small Area population estimates from https://www.nisra.gov.uk/publications/2020-mid-year-population-estimates-small-areas
tf <- download_file("https://www.nisra.gov.uk/system/files/statistics/SAPE20-SA-Totals.xlsx", ".xlsx")

population_sa <- read_excel(tf, sheet = "Tabular", skip = 7)

# Count up the number of people in each Small Area at risk of flooding, aggregating into Super Output Areas
people_flooded_soa <- 
  flood_sa %>% 
  st_drop_geometry() %>% 
  left_join(population_sa, by = c("SA2011" = "Area_Code")) %>% 
  
  group_by(soa_code = SOA2011) %>% 
  summarise(people_flooded = sum(`2020`)) %>% 
  ungroup()

# Calculate proportion of people flooded in each SOA
flood_soa <- 
  geographr::population_soa %>% 
  filter(sex == "All") %>% 
  select(soa_code, total_population) %>% 
  
  left_join(people_flooded_soa) %>% 
  
  mutate(people_flooded = replace_na(people_flooded, 0)) %>% 
    
  mutate(proportion_people_flooded = people_flooded / total_population)

# Save
flood_soa %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/2022-interim/northern-ireland/community-support/people-flooded-lsoa.rds")
