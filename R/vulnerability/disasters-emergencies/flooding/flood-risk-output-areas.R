library(dplyr)
library(readr)
library(sf)
library(geographr)

source("R/utils.R")  # for download_file()

# ---- Load flood risk areas ----
# Download historic flood map from https://environment.data.gov.uk/DefraDataDownload/?mapService=EA/HistoricFloodMap&Mode=spatial
# Note: You may need to generate a new download URL (below) from the link above
tf <- download_file("https://environment.data.gov.uk/UserDownloads/interactive/ce83de056162469ebe42c7f0dd36fd73145932/EA_FloodMapForPlanningRiversAndSeaFloodZone3_SHP_Full.zip", ".zip")

unzip(tf, exdir = tempdir())

flood_risk_areas <- read_sf(file.path(tempdir(), "data", "Flood_Map_for_Planning_Rivers_and_Sea_Flood_Zone_3.shp"))

# ---- Load Output Area boundaries ----
# Source: https://geoportal.statistics.gov.uk/datasets/ons::output-areas-december-2011-boundaries-ew-bfe/about
# Opening straight from the web takes far too long, so I manually downloaded a local copy and will load from that
# boundaries_oa <- read_sf("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Output_Areas_December_2011_Boundaries_EW_BFE/FeatureServer/0/query?where=1%3D1&outFields=OA11CD&outSR=4326&f=json")
boundaries_oa <- read_sf("data/vulnerability/disasters-emergencies/flooding/Output_Areas__December_2011__Boundaries_EW_BFE.shp")

# ---- Look up which Output Areas are in flood risk areas ----
flood_oa_shp <- 
  boundaries_oa %>% 
  st_join(flood_risk_areas)

# ---- Make a tibble containing all Output Areas with a flag for whether they're at risk of flooding or not ----
flood_oa <- 
  flood_oa_shp %>% 
  st_drop_geometry() %>% 
  filter(!is.na(layer)) %>% 
  select(oa_code = OA11CD) %>% 
  mutate(flood_risk = TRUE) %>% 
  distinct()

flood_oa <- 
  population_oa %>% 
  select(oa_code) %>% 
  left_join(flood_oa) %>% 
  mutate(flood_risk = replace_na(flood_risk, FALSE))

# This data will be used elsewhere, so save a copy rather than having to recalculate
flood_oa %>% 
  write_rds("data/vulnerability/disasters-emergencies/flooding/flood-risk-output-areas.rds")
